////////////////////////////////////////////////////////////////////////////////
// УчетУСНКлиентСервер: процедуры и функции для отражения документов в учете УСН,
// которые могут вызываться как на клиенте в формах документов, так и на сервере
//
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Возвращает сведения о применении на указанную дату коэффициента-дефлятора
// для индексации базового лимита доходов, ограничивающих право применения УСН.
//
// Параметры:
//  Дата - Дата - Дата, на которую получаем сведения об использовании дефлятора.
//
// Возвращаемое значение:
//  Булево - Булево - Если Истина, то коэффициент-дефлятор применяется
//
Функция ИспользуетсяКоэффициентДефлятор(Дата) Экспорт

	Возврат Год(Дата) < 2017 Или КоэффициентДефлятор(Дата) <> 1;

КонецФункции

// Возвращает размер коэффициента ежегодной индексации величины дохода УСН.
//
// Параметры:
//  Дата - Дата - Дата, на которую необходимо получить коэффициент.
//
// Возвращаемое значение:
//  Число
//
Функция КоэффициентДефлятор(Дата) Экспорт
	
	КоэффициентДефлятор = 1;
	Если Год(Дата) > 2021 Тогда
		// Приказ Минэкономразвития России от 30.10.2020 № 720.
		// В 2021 году в связи с появлением новых лимитов, коэффициент-дефлятор не используется
		// и начинает влиять на лимиты УСН только с 2022 года.
		// см. Письмо Минфина от 27 января 2021 г. N 03-11-06/2/4855
		КоэффициентДефлятор = 1.032;
	ИначеЕсли Год(Дата) >= 2017 Тогда
		КоэффициентДефлятор = 1;     // Федеральный закон от 03.07.2016 N 243-ФЗ
	ИначеЕсли Год(Дата) = 2016 Тогда
		КоэффициентДефлятор = 1.329; // Приказ Минэкономразвития России от 20.10.2015 № 772
	ИначеЕсли Год(Дата) = 2015 Тогда
		КоэффициентДефлятор = 1.147; // приказ Минэкономразвития России от 29.10.2014 № 685
	ИначеЕсли Год(Дата) = 2014 Тогда
		КоэффициентДефлятор = 1.067; // приказ Минэкономразвития России от 07.11.2013 № 652
	КонецЕсли;
	
	Возврат КоэффициентДефлятор;
	
КонецФункции

// Возвращает точность округления показателей УСН при расчете налога.
//
// Параметры:
//  ДатаРасчета - Дата - дата, на которую необходимо определить точность округления.
//
// Возвращаемое значение:
//  Число - точность округления
//
Функция РазрядностьОкругленияПоказателей(ДатаРасчета) Экспорт

	// С 1 квартала 2015 года расчет налога при выполнении "Закрытия месяца" производится в соответствии с
	// порядком заполнения деларации по УСН, опубликованным 17 декабря 2014 г. (приказ ФНС РФ № ММВ-7-3/352@):
	// промежуточные показатели, влияющие на налог и на авансовые платежи, перед расчетом округляются до целых рублей.
	//
	// Алгоритм расчета, применявшийся в регламентной операции до конца 2014 г., не изменяется.
	
	Возврат ?(ДатаРасчета >= '20150101', 0, 2);

КонецФункции

///////////////////////////////////////////////////////////////////////////////
// Заполнение данных для УСН в формах документов

// Структура параметров для процедур и функций отражения документов в УСН
//
Функция ПараметрыНастройкиУСН() Экспорт

	Параметры = Новый Структура;
	
	// обязательные
	Параметры.Вставить("ПрименениеУСН",       Ложь);
	Параметры.Вставить("ПрименениеУСНДоходы", Ложь);
	
	// общие - заполняются из свойств объекта и реквизитов формы
	Параметры.Вставить("Дата");
	Параметры.Вставить("ВидОперации");
	Параметры.Вставить("Налог");
	Параметры.Вставить("НалоговыйПериод");
	Параметры.Вставить("Контрагент");
	Параметры.Вставить("ДоговорКонтрагента");
	Параметры.Вставить("СчетУчетаРасчетовСКонтрагентом");
	Параметры.Вставить("ПринятоОт", "");
	Параметры.Вставить("Выдано", "");
	Параметры.Вставить("ВалютаДокумента");
	Параметры.Вставить("СтатьяДвиженияДенежныхСредств");
	Параметры.Вставить("СубконтоДт1");
	Параметры.Вставить("СубконтоКт1");
	Параметры.Вставить("ВалютаРегламентированногоУчета");
	Параметры.Вставить("КурсДокумента", 1);
	Параметры.Вставить("КратностьДокумента", 1);
	
	// специфичные - заполняются явным образом по месту использования
	Параметры.Вставить("НТТПоПродажнымЦенам", Ложь);
	Параметры.Вставить("НТТНаЕНВД",           Ложь);
	
	Параметры.Вставить("ОбязательныеПараметры", "ПрименениеУСН, ПрименениеУСНДоходы");
	
	Возврат Параметры;

КонецФункции

// Возвращает структуру параметров для настройки отражения документа в УСН
// значениями из реквизитов переданной формы и объекта
//
Функция ПараметрыФормыДокументаДляУСН(Форма) Экспорт

	Параметры = ПараметрыНастройкиУСН();
	
	ЗаполнитьЗначенияСвойств(Параметры, Форма); // Параметры из ФО формы
	
	Если НЕ Параметры.ПрименениеУСН Тогда
		Возврат Параметры;
	КонецЕсли; 
	
	Объект = Форма.Объект;
	
	ЗаполнитьЗначенияСвойств(Параметры, Форма.Объект); // Параметры из реквизитов объекта
	
	Если Объект.ВидОперации = ПредопределенноеЗначение("Перечисление.ВидыОперацийПКО.РозничнаяВыручка") Тогда
		Параметры.НТТПоПродажнымЦенам = Объект.ВыручкаСНТТ И Форма.УчетВПродажныхЦенах;
		Параметры.НТТНаЕНВД           = Форма.НТТНаЕНВД;
	ИначеЕсли Объект.ВидОперации = ПредопределенноеЗначение("Перечисление.ВидыОперацийОплатаПлатежнойКартой.РозничнаяВыручка") Тогда
		Параметры.НТТПоПродажнымЦенам = Форма.УчетВПродажныхЦенах;
		Параметры.НТТНаЕНВД           = Форма.НТТНаЕНВД;
	КонецЕсли;
	
	Возврат Параметры;
	
КонецФункции

// Возвращает ставки налога УСН, указанные в НК РФ.
// Ставка УСН доходы - п. 1 ст. 346.20 НК РФ.
// Ставка УСН доходы минус расходы - п. 2 ст. 346.20 НК РФ.
// Ставка минимального налога УСН доходы минус расходы - п. 6 ст. 346.18 НК РФ.
// Повышенная ставка УСН доходы - п. 1.1 ст. 346.20 НК РФ.
// Повышенная ставка УСН доходы минус расходы - п. 2.1 ст. 346.20 НК РФ.
//
// Возвращаемое значение:
//  Структура - ставки налогов.
//    * СтавкаУСНДоходы - Число.
//    * СтавкаУСНДоходыМинусРасходы - Число.
//    * СтавкаМинимальногоНалогаУСНДоходыМинусРасходы - Число.
//    * СтавкаУСНДоходыПовышенная - Число
//    * СтавкаУСНДоходыМинусРасходыПовышенная - Число
//
Функция НалоговыеСтавкиПоУмолчанию(Период = Неопределено) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("СтавкаУСНДоходы", 6);
	Результат.Вставить("СтавкаУСНДоходыМинусРасходы", 15);
	Результат.Вставить("СтавкаМинимальногоНалогаУСНДоходыМинусРасходы", 1);
	Если Период = Неопределено Или ДатаНачалаПрогрессивнойШкалы() <= Период Тогда
		Результат.Вставить("СтавкаУСНДоходыПовышенная", 8);
		Результат.Вставить("СтавкаУСНДоходыМинусРасходыПовышенная", 20);
	Иначе
		Результат.Вставить("СтавкаУСНДоходыПовышенная", Неопределено);
		Результат.Вставить("СтавкаУСНДоходыМинусРасходыПовышенная", Неопределено);
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

///////////////////////////////////////////////////////////////////////////////
// Формирование Книги учета доходов и расходов

Функция ДатаНачалаФормирования4РазделаКУДиР() Экспорт
	
	Возврат Дата(2013, 1, 1);
	
КонецФункции

// Дата, с которой требуется формировать раздел V "Уплаченный торговый сбор" Книги учета доходов и расходов.
//
Функция ДатаНачалаФормирования5РазделаКУДиР() Экспорт
	
	// Приказ Минфина РФ от 07.12.2016 N 227н.
	Возврат Дата(2018, 1, 1);
	
КонецФункции

// Возвращает дату начала действия прогрессивной шкалы УСН 
// 
// Возвращаемое значение:
//  Дата 
//
Функция ДатаНачалаПрогрессивнойШкалы() Экспорт
	
	// Федеральный закон от 31.07.2020 № 266-ФЗ
	Возврат Дата(2021, 1, 1);
	
КонецФункции

#КонецОбласти