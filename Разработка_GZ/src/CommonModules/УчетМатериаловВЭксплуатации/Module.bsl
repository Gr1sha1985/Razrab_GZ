////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ОБЩИЕ ПРОЦЕДУРЫ, ОТРАЖАЮЩИЕ ХОЗЯЙСТВЕННЫЕ ОПЕРАЦИИ В ПОДСИСТЕМЕ

Функция ДатаОтменыСпецодежды() Экспорт
	
	Возврат '20210101';
	
КонецФункции

#Область ПередачаМатериаловСотруднику

Процедура СформироватьДвиженияПередачаМатериаловСотруднику(ТаблицаМатериалы, ТаблицаСписанныеМатериалы, ТаблицаРеквизиты, Движения, Отказ) Экспорт

	Если Не ЗначениеЗаполнено(ТаблицаМатериалы) Тогда
		Возврат;
	КонецЕсли;
	
	Параметры = ПодготовитьПараметрыПередачаМатериаловСотруднику(ТаблицаМатериалы, ТаблицаСписанныеМатериалы, ТаблицаРеквизиты);
	Реквизиты = Параметры.Реквизиты[0];

	// ПОДГОТОВКА ПРОВЕДЕНИЯ ПО ДАННЫМ ИНФОРМАЦИОННОЙ БАЗЫ

	ТаблицаПереданныеСотрудникуМатериалы = ПодготовитьТаблицуПереданныеСотрудникуМатериалы(
		Параметры.ТаблицаМатериалы, Параметры.ТаблицаСписанныеМатериалы, Отказ);

	// ФОРМИРОВАНИЕ ДВИЖЕНИЙ

	СформироватьПроводкиПередачаМатериаловСотрудникуМЦ(ТаблицаПереданныеСотрудникуМатериалы, Реквизиты, Движения, Отказ);

КонецПроцедуры

Функция ПодготовитьПараметрыПередачаМатериаловСотруднику(ТаблицаМатериалы, ТаблицаСписанныеМатериалы, ТаблицаРеквизиты)
	
	Параметры = Новый Структура;
	
	// Подготовка таблицы Параметры.ТаблицаМатериалы
	
	СписокОбязательныхКолонок = ""
	+ "НомерСтроки,"                   // <Число> - номер строки в списке
	+ "СчетМЦ,"                        // <ПланСчетовСсылка.Хозрасчетный> - забалансовый счет учета материалов в эксплуатации (МЦ)
	+ "Номенклатура,"                  // <СправочникСсылка.Номенклатура> - номенклатура материалов в эксплуатации
	+ "ПартияМатериаловВЭксплуатации," // <Характеристика.ВидыСубконтоХозрасчетные> - партия материалов в эксплуатации
	+ "ФизЛицо,"                       // <СправочникСсылка.ФизическиеЛица> - материально-ответственное лицо
	+ "Подразделение,"                 // <Ссылка на справочник подразделений> - производственное подразделение организации
	+ "КоличествоМЦ,"                  // <Число,15,3> - количество материалов для учета на забалансовом счете (МЦ)
	+ "Содержание";                    // <Строка> - содержание проводки
	
	Параметры.Вставить("ТаблицаМатериалы", 
		ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(ТаблицаМатериалы, СписокОбязательныхКолонок));
	
	// Подготовка таблицы Параметры.ТаблицаСписанныеМатериалы
	
	СписокОбязательныхКолонок = ""
	+ "НомерСтроки,"                   // <Число> - номер строки в списке
	+ "СуммаСписания,"                 // <Число,15,2> - себестоимость материалов, определенная по данным остатков
	+ "СуммаСписанияНУ,"               // <Число,15,2> - себестоимость материалов (НУ), определенная по данным остатков
	+ "СуммаСписанияПР,"               // <Число,15,2> - сумма постоянных разниц (ПБУ 18/02) в себестоимости материалов, определенной по данным остатков
	+ "СуммаСписанияВР";               // <Число,15,2> - сумма временных разниц (ПБУ 18/02) в себестоимости материалов, определенной по данным остатков
	
	Параметры.Вставить("ТаблицаСписанныеМатериалы", 
		ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(ТаблицаСписанныеМатериалы, СписокОбязательныхКолонок));
	
	// Подготовка таблицы Параметры.Реквизиты
	
	СписокОбязательныхКолонок = ""
	+ "Период,"                        // <Дата> - период движений - дата документа
	+ "Организация,"                   // <СправочникСсылка.Организации>
	+ "СпособУчетаМатериаловПоСотруднику,"
	+ "Регистратор";                   // <ДокументСсылка.*> - документ-регистратор движений
	
	Параметры.Вставить("Реквизиты", 
		ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(ТаблицаРеквизиты, СписокОбязательныхКолонок));
	
	Возврат Параметры;
	
КонецФункции

Функция ПодготовитьТаблицуПереданныеСотрудникуМатериалы(ТаблицаМатериалы, ТаблицаСписанныеМатериалы, Отказ)
	
	ОписаниеТипаЧисла15_2 = ОбщегоНазначения.ОписаниеТипаЧисло(15, 2);
	
	ТаблицаМатериалы.Колонки.Добавить("Сумма",     ОписаниеТипаЧисла15_2);
	ТаблицаМатериалы.Колонки.Добавить("СуммаМЦ",   ОписаниеТипаЧисла15_2);
	ТаблицаМатериалы.Колонки.Добавить("СуммаНУ",   ОписаниеТипаЧисла15_2);
	ТаблицаМатериалы.Колонки.Добавить("СуммаМЦНУ", ОписаниеТипаЧисла15_2);
	ТаблицаМатериалы.Колонки.Добавить("СуммаПР",   ОписаниеТипаЧисла15_2);
	ТаблицаМатериалы.Колонки.Добавить("СуммаВР",   ОписаниеТипаЧисла15_2);
	
	Если ТаблицаМатериалы.Количество() = 0 Тогда
		Возврат ТаблицаМатериалы;
	КонецЕсли;
	
	ТаблицаСписанныеМатериалы.Свернуть("НомерСтроки", "СуммаСписания,СуммаСписанияНУ,СуммаСписанияПР,СуммаСписанияВР");
	
	Для каждого СтрокаТаблицы Из ТаблицаМатериалы Цикл
		
		Если СтрокаТаблицы.НомерСтроки > ТаблицаСписанныеМатериалы.Количество() Тогда
			Продолжить;
		КонецЕсли;
		
		СтрокаСписания = ТаблицаСписанныеМатериалы[СтрокаТаблицы.НомерСтроки - 1];
		
		СтрокаТаблицы.Сумма = СтрокаСписания.СуммаСписания;
		СтрокаТаблицы.СуммаНУ = СтрокаСписания.СуммаСписанияНУ;
		СтрокаТаблицы.СуммаМЦ = СтрокаСписания.СуммаСписания;
		СтрокаТаблицы.СуммаМЦНУ = СтрокаСписания.СуммаСписанияНУ;
		СтрокаТаблицы.СуммаПР = СтрокаСписания.СуммаСписанияПР;
		СтрокаТаблицы.СуммаВР = СтрокаСписания.СуммаСписанияВР;
		
	КонецЦикла;
	
	Возврат ТаблицаМатериалы;

КонецФункции

Процедура СформироватьПроводкиПередачаМатериаловСотрудникуМЦ(ТаблицаМатериалы, Реквизиты, Движения, Отказ)
	
	Для каждого СтрокаТаблицы из ТаблицаМатериалы Цикл

		Если СтрокаТаблицы.Сумма = 0
				И СтрокаТаблицы.КоличествоМЦ = 0 Тогда
			Продолжить;
		КонецЕсли;
	
		Проводка = Движения.Хозрасчетный.Добавить();
		Проводка.Период      = Реквизиты.Период;
		Проводка.Организация = Реквизиты.Организация;
		
		Проводка.Содержание  = СтрокаТаблицы.Содержание;
		
		Проводка.СчетДт = СтрокаТаблицы.СчетМЦ;
		
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт, Проводка.СубконтоДт, "Номенклатура", СтрокаТаблицы.Номенклатура);
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт, Проводка.СубконтоДт, "ПартииМатериаловВЭксплуатации", СтрокаТаблицы.ПартияМатериаловВЭксплуатации);
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт, Проводка.СубконтоДт, "РаботникиОрганизаций", СтрокаТаблицы.ФизЛицо);
		
		СвойстваСчетаДт = БухгалтерскийУчетВызовСервераПовтИсп.ПолучитьСвойстваСчета(Проводка.СчетДт);
		
		Если СвойстваСчетаДт.УчетПоПодразделениям Тогда
			Проводка.ПодразделениеДт = СтрокаТаблицы.Подразделение;
		КонецЕсли;
		
		Если СвойстваСчетаДт.Количественный Тогда
			Проводка.КоличествоДт = СтрокаТаблицы.КоличествоМЦ;
		КонецЕсли;
		
		// При выборе способа учета Расход сразу же списываем материалы со счета МЦ.
		Если Реквизиты.СпособУчетаМатериаловПоСотруднику = Перечисления.СпособыУчетаМатериаловПоСотрудникам.Расход Тогда
			Проводка.СчетКт = СтрокаТаблицы.СчетМЦ;
			СвойстваСчетаКт = БухгалтерскийУчетВызовСервераПовтИсп.ПолучитьСвойстваСчета(Проводка.СчетДт);
			
			БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетКт, Проводка.СубконтоКт, "Номенклатура", СтрокаТаблицы.Номенклатура);
			БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетКт, Проводка.СубконтоКт, "ПартииМатериаловВЭксплуатации", СтрокаТаблицы.ПартияМатериаловВЭксплуатации);
			БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетКт, Проводка.СубконтоКт, "РаботникиОрганизаций", СтрокаТаблицы.ФизЛицо);
			
			Если СвойстваСчетаКт.УчетПоПодразделениям Тогда
				Проводка.ПодразделениеКт = СтрокаТаблицы.Подразделение;
			КонецЕсли;
			
			Если СвойстваСчетаКт.Количественный Тогда
				Проводка.КоличествоКт = СтрокаТаблицы.КоличествоМЦ;
			КонецЕсли;
		КонецЕсли;
		
		Проводка.Сумма = СтрокаТаблицы.Сумма;
		
	КонецЦикла;
	
	Движения.Хозрасчетный.Записывать = Истина;
	
КонецПроцедуры

#КонецОбласти

// ПЕРЕДАЧА МАТЕРИАЛОВ В ЭКСПЛУАТАЦИЮ

Процедура СформироватьДвиженияПередачаСпецодеждыСпецоснасткиВЭксплуатацию(ТаблицаМатериалы, ТаблицаСписанныеМатериалы, ТаблицаРеквизиты, Движения, Отказ) Экспорт

	Если Не ЗначениеЗаполнено(ТаблицаМатериалы) Тогда
		Возврат;
	КонецЕсли;
	
	Параметры = ПодготовитьПараметрыПередачаСпецодеждыСпецоснасткиВЭксплуатацию(ТаблицаМатериалы, ТаблицаСписанныеМатериалы, ТаблицаРеквизиты);
	Реквизиты = Параметры.Реквизиты[0];

	// ПОДГОТОВКА ПРОВЕДЕНИЯ ПО ДАННЫМ ИНФОРМАЦИОННОЙ БАЗЫ

	ТаблицаПереданныеМатериалы = ПодготовитьТаблицуПереданныеВЭксплуатациюМатериалы(
		Параметры.ТаблицаМатериалы, Параметры.ТаблицаСписанныеМатериалы, Отказ);
	
	ТаблицаНачислениеПогашенияСтоимостиМатериалов = ПодготовитьТаблицуНачислениеПогашенияСтоимостиСпецодеждыСпецоснастки(
		ТаблицаПереданныеМатериалы, Реквизиты, Отказ);

	// ФОРМИРОВАНИЕ ДВИЖЕНИЙ
	
	СформироватьПроводкиПогашениеСтоимостиСпецодеждыСпецоснастки(
		ТаблицаНачислениеПогашенияСтоимостиМатериалов, Реквизиты, Движения, Отказ);
	
	СформироватьПроводкиПоступлениеСпецодеждыСпецоснасткиВЭксплуатациюМЦ(
		ТаблицаНачислениеПогашенияСтоимостиМатериалов, Реквизиты, Движения, Отказ);

КонецПроцедуры

Функция ПодготовитьПараметрыПередачаСпецодеждыСпецоснасткиВЭксплуатацию(ТаблицаМатериалы, ТаблицаСписанныеМатериалы, ТаблицаРеквизиты)
	
	Параметры = Новый Структура;
	
	// Подготовка таблицы Параметры.ТаблицаМатериалы
	
	СписокОбязательныхКолонок = ""
	+ "ИмяСписка,"                     // <Строка,0> - имя списка в документе
	+ "НомерСтроки,"                   // <Число> - номер строки в списке
	+ "СчетПередачи,"                  // <ПланСчетовСсылка.Хозрасчетный> - счет учета материалов в эксплуатации
	+ "СчетМЦ,"                        // <ПланСчетовСсылка.Хозрасчетный> - забалансовый счет учета материалов в эксплуатации (МЦ)
	+ "Номенклатура,"                  // <СправочникСсылка.Номенклатура> - номенклатура материалов в эксплуатации
	+ "ПартияМатериаловВЭксплуатации," // <Характеристика.ВидыСубконтоХозрасчетные> - партия материалов в эксплуатации
	+ "ФизЛицо,"                       // <СправочникСсылка.ФизическиеЛица> - материально-ответственное лицо
	+ "Подразделение,"                 // <Ссылка на справочник подразделений> - производственное подразделение организации
	+ "СпособПогашенияСтоимости,"      // <ПеречислениеСсылка.СпособыПогашенияСтоимости> - способ погашения стоимости материалов
	+ "СпособПогашенияСтоимостиНУ,"      // <ПеречислениеСсылка.СпособыПогашенияСтоимости> - способ погашения стоимости материалов в НУ
	+ "СпособОтраженияРасходов,"       // <СправочникСсылка.СпособыОтраженияРасходов> - способ отражения в затратах погашенной стоимости материалов
	+ "Количество,"                    // <Число,15,3> - количество материалов для погашения стоимости
	+ "КоличествоМЦ";                  // <Число,15,3> - количество материалов для учета на забалансовом счете (МЦ)
	
	Параметры.Вставить("ТаблицаМатериалы", 
		ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(ТаблицаМатериалы, СписокОбязательныхКолонок));
	
	// Подготовка таблицы Параметры.ТаблицаСписанныеМатериалы
	
	СписокОбязательныхКолонок = ""
	+ "НомерСтроки,"                   // <Число> - номер строки в списке
	+ "СуммаСписания,"                 // <Число,15,2> - себестоимость материалов, определенная по данным остатков
	+ "СуммаСписанияНУ,"               // <Число,15,2> - себестоимость материалов (НУ), определенная по данным остатков
	+ "СуммаСписанияПР,"               // <Число,15,2> - сумма постоянных разниц (ПБУ 18/02) в себестоимости материалов, определенной по данным остатков
	+ "СуммаСписанияВР";               // <Число,15,2> - сумма временных разниц (ПБУ 18/02) в себестоимости материалов, определенной по данным остатков
	
	Параметры.Вставить("ТаблицаСписанныеМатериалы", 
		ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(ТаблицаСписанныеМатериалы, СписокОбязательныхКолонок));
	
	// Подготовка таблицы Параметры.Реквизиты
	
	СписокОбязательныхКолонок = ""
	+ "Период,"                        // <Дата> - период движений - дата документа
	+ "Организация,"                   // <СправочникСсылка.Организации>
	+ "Регистратор";                   // <ДокументСсылка.*> - документ-регистратор движений
	
	Параметры.Вставить("Реквизиты", 
		ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(ТаблицаРеквизиты, СписокОбязательныхКолонок));
	
	Возврат Параметры;
	
КонецФункции

Процедура СформироватьДвиженияПередачаИнвентаряВЭксплуатацию(ТаблицаМатериалы, ТаблицаСписанныеМатериалы, ТаблицаРеквизиты, Движения, Отказ) Экспорт

	Если Не ЗначениеЗаполнено(ТаблицаМатериалы) Тогда
		Возврат;
	КонецЕсли;
	
	Параметры = ПодготовитьПараметрыПередачаИнвентаряВЭксплуатацию(ТаблицаМатериалы, ТаблицаСписанныеМатериалы, ТаблицаРеквизиты);
	Реквизиты = Параметры.Реквизиты[0];

	// ПОДГОТОВКА ПРОВЕДЕНИЯ ПО ДАННЫМ ИНФОРМАЦИОННОЙ БАЗЫ

	Если Реквизиты.Период < УчетМатериаловВЭксплуатации.ДатаОтменыСпецодежды() Тогда
		ТаблицаПереданныйИнвентарь = ПодготовитьТаблицуПереданныеВЭксплуатациюМатериалы(
			Параметры.ТаблицаМатериалы, Параметры.ТаблицаСписанныеМатериалы, Отказ);
	Иначе
		ТаблицаПереданныйИнвентарь = ПодготовитьТаблицуПереданныеВЭксплуатациюМатериалы2021(
			Параметры.ТаблицаМатериалы, Параметры.ТаблицаСписанныеМатериалы, Отказ);
	КонецЕсли;

	// ФОРМИРОВАНИЕ ДВИЖЕНИЙ

	СформироватьПроводкиПоступлениеИнвентаряВЭксплуатациюМЦ(ТаблицаПереданныйИнвентарь, Реквизиты, Движения, Отказ);

КонецПроцедуры

Функция ПодготовитьПараметрыПередачаИнвентаряВЭксплуатацию(ТаблицаМатериалы, ТаблицаСписанныеМатериалы, ТаблицаРеквизиты)
	
	Параметры = Новый Структура;
	
	// Подготовка таблицы Параметры.ТаблицаМатериалы
	
	СписокОбязательныхКолонок = ""
	+ "ИмяСписка,"                     // <Строка,0> - имя списка в документе
	+ "НомерСтроки,"                   // <Число> - номер строки в списке
	+ "СчетМЦ,"                        // <ПланСчетовСсылка.Хозрасчетный> - забалансовый счет учета материалов в эксплуатации (МЦ)
	+ "Номенклатура,"                  // <СправочникСсылка.Номенклатура> - номенклатура материалов в эксплуатации
	+ "ПартияМатериаловВЭксплуатации," // <Характеристика.ВидыСубконтоХозрасчетные> - партия материалов в эксплуатации
	+ "ФизЛицо,"                       // <СправочникСсылка.ФизическиеЛица> - материально-ответственное лицо
	+ "Подразделение,"                 // <Ссылка на справочник подразделений> - производственное подразделение организации
	+ "КоличествоМЦ";                  // <Число,15,3> - количество материалов для учета на забалансовом счете (МЦ)
	
	Параметры.Вставить("ТаблицаМатериалы", 
		ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(ТаблицаМатериалы, СписокОбязательныхКолонок));
	
	// Подготовка таблицы Параметры.ТаблицаСписанныеМатериалы
	
	СписокОбязательныхКолонок = ""
	+ "НомерСтроки,"                   // <Число> - номер строки в списке
	+ "СуммаСписания,"                 // <Число,15,2> - себестоимость материалов, определенная по данным остатков
	+ "СуммаСписанияНУ,"               // <Число,15,2> - себестоимость материалов (НУ), определенная по данным остатков
	+ "СуммаСписанияПР,"               // <Число,15,2> - сумма постоянных разниц (ПБУ 18/02) в себестоимости материалов, определенной по данным остатков
	+ "СуммаСписанияВР";               // <Число,15,2> - сумма временных разниц (ПБУ 18/02) в себестоимости материалов, определенной по данным остатков
	
	Параметры.Вставить("ТаблицаСписанныеМатериалы", 
		ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(ТаблицаСписанныеМатериалы, СписокОбязательныхКолонок));
	
	// Подготовка таблицы Параметры.Реквизиты
	
	СписокОбязательныхКолонок = ""
	+ "Период,"                        // <Дата> - период движений - дата документа
	+ "Организация,"                   // <СправочникСсылка.Организации>
	+ "Регистратор";                   // <ДокументСсылка.*> - документ-регистратор движений
	
	Параметры.Вставить("Реквизиты", 
		ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(ТаблицаРеквизиты, СписокОбязательныхКолонок));
	
	Возврат Параметры;
	
КонецФункции

// ВОЗВРАТ МАТЕРИАЛОВ ИЗ ЭКСПЛУАТАЦИИ

Функция ПодготовитьТаблицыОстатковВозвратСпецодеждыСпецоснасткиИзЭксплуатации(ТаблицаМатериалы, ТаблицаРеквизиты, Отказ) Экспорт

	Если Не ЗначениеЗаполнено(ТаблицаМатериалы) Тогда
		Отказ = Истина;
		Возврат Неопределено;
	КонецЕсли;
	
	Параметры = ПодготовитьПараметрыВозвратСпецодеждыСпецоснасткиИзЭксплуатации(ТаблицаМатериалы, ТаблицаРеквизиты);
	Реквизиты = Параметры.Реквизиты[0];
	
	СтруктураТаблиц = Новый Структура("ТаблицаНачислениеПогашенияСтоимостиМатериалов, ТаблицаСписанныеМатериалы");
	
	// ПОДГОТОВКА ПРОВЕДЕНИЯ ПО ДАННЫМ ИНФОРМАЦИОННОЙ БАЗЫ

	ТаблицаПогашениеСтоимостиМатериалов = ПодготовитьТаблицуПогашениеСтоимостиСпецодеждыСпецоснастки(
		Параметры.ТаблицаМатериалы, Реквизиты, Отказ);
	
	СтруктураТаблиц.ТаблицаНачислениеПогашенияСтоимостиМатериалов = ПодготовитьТаблицуНачислениеПогашенияСтоимостиСпецодеждыСпецоснастки(
		ТаблицаПогашениеСтоимостиМатериалов, Реквизиты, Отказ);
	
	СтруктураТаблиц.ТаблицаСписанныеМатериалы = ПодготовитьТаблицуСписанныеИзЭксплуатацииСпецодеждаСпецоснастка(
		Параметры.ТаблицаМатериалы, ТаблицаПогашениеСтоимостиМатериалов, Реквизиты, Отказ);

	Возврат СтруктураТаблиц;
		
КонецФункции
 
Процедура СформироватьДвиженияВозвратСпецодеждыСпецоснасткиИзЭксплуатации(ТаблицаНачислениеПогашенияСтоимостиМатериалов, ТаблицаСписанныеМатериалы, ТаблицаРеквизиты, Движения, Отказ) Экспорт

	Реквизиты = ТаблицаРеквизиты[0];

	// ФОРМИРОВАНИЕ ДВИЖЕНИЙ

	СформироватьПроводкиПогашениеСтоимостиСпецодеждыСпецоснастки(
		ТаблицаНачислениеПогашенияСтоимостиМатериалов, Реквизиты, Движения, Отказ);

	СформироватьПроводкиСписаниеМатериаловИзЭксплуатации(
		ТаблицаСписанныеМатериалы, Реквизиты, Движения, Отказ);
		
	СформироватьПроводкиСписаниеМатериаловИзЭксплуатацииМЦ(
		ТаблицаСписанныеМатериалы, Реквизиты, Движения, Отказ);
	
КонецПроцедуры

Функция ПодготовитьПараметрыВозвратСпецодеждыСпецоснасткиИзЭксплуатации(ТаблицаМатериалы, ТаблицаРеквизиты)
	
	Параметры = Новый Структура;
	
	// Подготовка таблицы Параметры.ТаблицаМатериалы
	
	СписокОбязательныхКолонок = ""
	+ "ИмяСписка,"                     // <Строка,0> - имя списка в документе
	+ "СинонимСписка,"                 // <Строка,0> - синоним списка
	+ "НомерСтроки,"                   // <Число> - номер строки в списке
	+ "СчетУчета,"                     // <ПланСчетовСсылка.Хозрасчетный> -  счет учета материалов на складе
	+ "СчетПередачи,"                  // <ПланСчетовСсылка.Хозрасчетный> - счет учета материалов в эксплуатации
	+ "СчетМЦ,"                        // <ПланСчетовСсылка.Хозрасчетный> - забалансовый счет учета материалов в эксплуатации (МЦ)
	+ "Номенклатура,"                  // <СправочникСсылка.Номенклатура> - номенклатура материалов в эксплуатации
	+ "ПартияМатериаловВЭксплуатации," // <Характеристика.ВидыСубконтоХозрасчетные> - партия материалов в эксплуатации
	+ "ФизЛицо,"                       // <СправочникСсылка.ФизическиеЛица> - материально-ответственное лицо
	+ "Подразделение,"                 // <Ссылка на справочник подразделений> - производственное подразделение организации
	+ "СчетРасходов,"                  // <ПланСчетовСсылка.Хозрасчетный> - счет списания материалов из эксплуатации
	+ "ВидСубконтоРасходов1,"          // <Число/Строка/ПланВидовХарактеристикСсылка.ВидыСубконтоХозрасчетные> - вид субконто счета расходов
	+ "ВидСубконтоРасходов2,"          // <Число/Строка/ПланВидовХарактеристикСсылка.ВидыСубконтоХозрасчетные> - вид субконто счета расходов
	+ "ВидСубконтоРасходов3,"          // <Число/Строка/ПланВидовХарактеристикСсылка.ВидыСубконтоХозрасчетные> - вид субконто счета расходов
	+ "СубконтоРасходов1,"             // - значение субконто счета расходов
	+ "СубконтоРасходов2,"             // - значение субконто счета расходов
	+ "СубконтоРасходов3,"             // - значение субконто счета расходов
	+ "Количество,"                    // <Число,15,3> - количество возвращенных материалов
	+ "Содержание";                    // <Строка,150> - содержание проводки
	
	Параметры.Вставить("ТаблицаМатериалы", 
		ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(ТаблицаМатериалы, СписокОбязательныхКолонок));
	
	// Подготовка таблицы Параметры.Реквизиты
	
	СписокОбязательныхКолонок = ""
	+ "Регистратор,"                   // <ДокументСсылка.*> - документ-регистратор движений
	+ "Период,"                        // <Дата> - период движений - дата документа
	+ "Организация,"                   // <СправочникСсылка.Организации>
	+ "Подразделение";                 // <Ссылка на справочник подразделений> - производственное подразделение организации
	
	Параметры.Вставить("Реквизиты", 
		ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(ТаблицаРеквизиты, СписокОбязательныхКолонок));
	
	Возврат Параметры;
	
КонецФункции

// СПИСАНИЕ МАТЕРИАЛОВ ИЗ ЭКСПЛУАТАЦИИ

Процедура СформироватьДвиженияСписаниеСпецодеждыСпецоснасткиИзЭксплуатации(ТаблицаМатериалы, ТаблицаРеквизиты, Движения, Отказ) Экспорт

	Если Не ЗначениеЗаполнено(ТаблицаМатериалы) Тогда
		Возврат;
	КонецЕсли;
	
	Параметры = ПодготовитьПараметрыСписаниеСпецодеждыСпецоснасткиИзЭксплуатации(ТаблицаМатериалы, ТаблицаРеквизиты);
	Реквизиты = Параметры.Реквизиты[0];

	// ПОДГОТОВКА ПРОВЕДЕНИЯ ПО ДАННЫМ ИНФОРМАЦИОННОЙ БАЗЫ

	ТаблицаПогашениеСтоимостиМатериалов = ПодготовитьТаблицуПогашениеСтоимостиСпецодеждыСпецоснастки(
		Параметры.ТаблицаМатериалы, Реквизиты, Отказ);
	
	ТаблицаНачислениеПогашенияСтоимостиМатериалов = ПодготовитьТаблицуНачислениеПогашенияСтоимостиСпецодеждыСпецоснастки(
		ТаблицаПогашениеСтоимостиМатериалов, Реквизиты, Отказ);
	
	ТаблицаСписанныеМатериалы = ПодготовитьТаблицуСписанныеИзЭксплуатацииСпецодеждаСпецоснастка(
		Параметры.ТаблицаМатериалы, ТаблицаПогашениеСтоимостиМатериалов, Реквизиты, Отказ);
	
	Если НЕ Реквизиты.СписыватьВДебетСчетаУказанногоВДокументе Тогда
		ТаблицаСписаныеПоНазначениюИспользованияМатериалы = ПодготовитьТаблицуСписанныеПоНазначениюИспользованияСпецодеждаСпецоснастка(
			ТаблицаСписанныеМатериалы, Реквизиты, Отказ);
	КонецЕсли;

	// ФОРМИРОВАНИЕ ДВИЖЕНИЙ

	СформироватьПроводкиПогашениеСтоимостиСпецодеждыСпецоснастки(
		ТаблицаНачислениеПогашенияСтоимостиМатериалов, Реквизиты, Движения, Отказ);

	Если Реквизиты.СписыватьВДебетСчетаУказанногоВДокументе Тогда
		СформироватьПроводкиСписаниеМатериаловИзЭксплуатации(
			ТаблицаСписанныеМатериалы, Реквизиты, Движения, Отказ);
	Иначе
		СформироватьПроводкиСписаниеМатериаловИзЭксплуатации(
			ТаблицаСписаныеПоНазначениюИспользованияМатериалы, Реквизиты, Движения, Отказ);
	КонецЕсли;
	
	СформироватьПроводкиСписаниеМатериаловИзЭксплуатацииМЦ(
		ТаблицаСписанныеМатериалы, Реквизиты, Движения, Отказ);
	
КонецПроцедуры

Функция ПодготовитьПараметрыСписаниеСпецодеждыСпецоснасткиИзЭксплуатации(ТаблицаМатериалы, ТаблицаРеквизиты)
	
	Параметры = Новый Структура;
	
	// Подготовка таблицы Параметры.ТаблицаМатериалы
	
	СписокОбязательныхКолонок = ""
	+ "ИмяСписка,"                     // <Строка,0> - имя списка в документе
	+ "СинонимСписка,"                 // <Строка,0> - синоним списка
	+ "НомерСтроки,"                   // <Число> - номер строки в списке
	+ "СчетПередачи,"                  // <ПланСчетовСсылка.Хозрасчетный> - счет учета материалов в эксплуатации
	+ "СчетМЦ,"                        // <ПланСчетовСсылка.Хозрасчетный> - забалансовый счет учета материалов в эксплуатации (МЦ)
	+ "Номенклатура,"                  // <СправочникСсылка.Номенклатура> - номенклатура материалов в эксплуатации
	+ "ПартияМатериаловВЭксплуатации," // <Характеристика.ВидыСубконтоХозрасчетные> - партия материалов в эксплуатации
	+ "ФизЛицо,"                       // <СправочникСсылка.ФизическиеЛица> - материально-ответственное лицо
	+ "Подразделение,"                 // <Ссылка на справочник подразделений> - производственное подразделение организации
	+ "СчетРасходов,"                  // <ПланСчетовСсылка.Хозрасчетный> - счет списания материалов из эксплуатации
	+ "ВидСубконтоРасходов1,"          // <Число/Строка/ПланВидовХарактеристикСсылка.ВидыСубконтоХозрасчетные> - вид субконто счета расходов
	+ "ВидСубконтоРасходов2,"          // <Число/Строка/ПланВидовХарактеристикСсылка.ВидыСубконтоХозрасчетные> - вид субконто счета расходов
	+ "ВидСубконтоРасходов3,"          // <Число/Строка/ПланВидовХарактеристикСсылка.ВидыСубконтоХозрасчетные> - вид субконто счета расходов
	+ "СубконтоРасходов1,"             // - значение субконто счета расходов
	+ "СубконтоРасходов2,"             // - значение субконто счета расходов
	+ "СубконтоРасходов3,"             // - значение субконто счета расходов
	+ "Количество,"                    // <Число,15,3> - количество списанных материалов
	+ "Содержание";                    // <Строка,150> - содержание проводки
	
	Параметры.Вставить("ТаблицаМатериалы", 
		ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(ТаблицаМатериалы, СписокОбязательныхКолонок));
	
	// Подготовка таблицы Параметры.Реквизиты
	
	СписокОбязательныхКолонок = ""
	+ "Регистратор,"                              // <ДокументСсылка.*> - документ-регистратор движений
	+ "Период,"                                   // <Дата> - период движений - дата документа
	+ "Организация,"                              // <СправочникСсылка.Организации>
	+ "Подразделение,"                            // <Ссылка на справочник подразделений> - производственное подразделение организации
	+ "СписыватьВДебетСчетаУказанногоВДокументе"; // <Булево> - способ списания материалов из эксплуатации
	
	Параметры.Вставить("Реквизиты", 
		ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(ТаблицаРеквизиты, СписокОбязательныхКолонок));
	
	Возврат Параметры;
	
КонецФункции

Процедура СформироватьДвиженияСписаниеИнвентаряИзЭксплуатации(ТаблицаМатериалы, ТаблицаРеквизиты, Движения, Отказ) Экспорт

	Если Не ЗначениеЗаполнено(ТаблицаМатериалы) Тогда
		Возврат;
	КонецЕсли;
	
	Параметры = ПодготовитьПараметрыСписаниеИнвентаряИзЭксплуатации(ТаблицаМатериалы, ТаблицаРеквизиты);
	Реквизиты = Параметры.Реквизиты[0];

	// ПОДГОТОВКА ПРОВЕДЕНИЯ ПО ДАННЫМ ИНФОРМАЦИОННОЙ БАЗЫ

	ТаблицаСписанныйИнвентарь = ПодготовитьТаблицуСписанныйИзЭксплуатацииИнвентарь(
		Параметры.ТаблицаМатериалы, Реквизиты, Отказ);

	// ФОРМИРОВАНИЕ ДВИЖЕНИЙ

	СформироватьПроводкиСписаниеМатериаловИзЭксплуатацииМЦ(
		ТаблицаСписанныйИнвентарь, Реквизиты, Движения, Отказ);
	
КонецПроцедуры

Функция ПодготовитьПараметрыСписаниеИнвентаряИзЭксплуатации(ТаблицаМатериалы, ТаблицаРеквизиты)
	
	Параметры = Новый Структура;
	
	// Подготовка таблицы Параметры.ТаблицаМатериалы
	
	СписокОбязательныхКолонок = ""
	+ "ИмяСписка,"                     // <Строка,0> - имя списка в документе
	+ "СинонимСписка,"                 // <Строка,0> - синоним списка
	+ "НомерСтроки,"                   // <Число> - номер строки в списке
	+ "СчетМЦ,"                        // <ПланСчетовСсылка.Хозрасчетный> - забалансовый счет учета материалов в эксплуатации (МЦ)
	+ "Номенклатура,"                  // <СправочникСсылка.Номенклатура> - номенклатура материалов в эксплуатации
	+ "ПартияМатериаловВЭксплуатации," // <Характеристика.ВидыСубконтоХозрасчетные> - партия материалов в эксплуатации
	+ "ФизЛицо,"                       // <СправочникСсылка.ФизическиеЛица> - материально-ответственное лицо
	+ "КоличествоМЦ,"                  // <Число,15,3> - количество материалов для погашения стоимости
	+ "Содержание";                    // <Строка,150> - содержание проводки
	
	Параметры.Вставить("ТаблицаМатериалы", 
		ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(ТаблицаМатериалы, СписокОбязательныхКолонок));
	
	// Подготовка таблицы Параметры.Реквизиты
	
	СписокОбязательныхКолонок = ""
	+ "Регистратор,"                   // <ДокументСсылка.*> - документ-регистратор движений
	+ "Период,"                        // <Дата> - период движений - дата документа
	+ "Организация,"                   // <СправочникСсылка.Организации>
	+ "Подразделение";                 // <Ссылка на справочник подразделений> - производственное подразделение организации
	
	Параметры.Вставить("Реквизиты", 
		ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(ТаблицаРеквизиты, СписокОбязательныхКолонок));
	
	Возврат Параметры;
	
КонецФункции

// РЕГЛАМЕНТНАЯ ОПЕРАЦИЯ "ПОГАШЕНИЕ СТОИМОСТИ СПЕЦОДЕЖДЫ, СПЕЦОСНАСТКИ"

Процедура СформироватьДвиженияПогашениеСтоимостиСпецодеждыСпецоснасткиРеглОперация(ТаблицаРеквизиты, Движения, Отказ) Экспорт

	Параметры = ПодготовитьПараметрыПогашениеСтоимостиСпецодеждыСпецоснасткиРеглОперация(ТаблицаРеквизиты);
	
	Реквизиты = Параметры.Реквизиты[0];

	// ПОДГОТОВКА ПРОВЕДЕНИЯ ПО ДАННЫМ ИНФОРМАЦИОННОЙ БАЗЫ

	ТаблицаПогашениеСтоимостиМатериалов = ПодготовитьТаблицуПогашениеСтоимостиСпецодеждыСпецоснастки(
		Неопределено, Реквизиты, Отказ);
	
	ТаблицаНачислениеПогашенияСтоимостиМатериалов = ПодготовитьТаблицуНачислениеПогашенияСтоимостиСпецодеждыСпецоснастки(
		ТаблицаПогашениеСтоимостиМатериалов, Реквизиты, Отказ);

	// ФОРМИРОВАНИЕ ДВИЖЕНИЙ

	СформироватьПроводкиПогашениеСтоимостиСпецодеждыСпецоснастки(
		ТаблицаНачислениеПогашенияСтоимостиМатериалов, Реквизиты, Движения, Отказ);
		
КонецПроцедуры

Функция ПодготовитьПараметрыПогашениеСтоимостиСпецодеждыСпецоснасткиРеглОперация(ТаблицаРеквизиты)
	
	Параметры = Новый Структура;
	
	// Подготовка таблицы Параметры.Реквизиты
	
	СписокОбязательныхКолонок = ""
	+ "Регистратор,"                   // <ДокументСсылка.*> - документ-регистратор движений
	+ "Период,"                        // <Дата> - период движений - дата документа
	+ "Организация";                   // <СправочникСсылка.Организации>
	
	Параметры.Вставить("Реквизиты", 
		ОбщегоНазначенияБПВызовСервера.ПолучитьТаблицуПараметровПроведения(ТаблицаРеквизиты, СписокОбязательныхКолонок));
	
	Возврат Параметры;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ, ВЫПОЛНЯЮЩИЕ ПОДГОТОВКУ ПРОВЕДЕНИЯ

// ПОДГОТОВКА ПЕРЕДАЧИ МАТЕРИАЛОВ В ЭКСПЛУАТАЦИЮ

Функция ПодготовитьТаблицуПереданныеВЭксплуатациюМатериалы(ТаблицаМатериалы, ТаблицаСписанныеМатериалы, Отказ)
	
	ТаблицаМатериалы.Колонки.Добавить("Сумма", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	ТаблицаМатериалы.Колонки.Добавить("СуммаМЦ", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	ТаблицаМатериалы.Колонки.Добавить("СуммаНУ", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	ТаблицаМатериалы.Колонки.Добавить("СуммаМЦНУ", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	ТаблицаМатериалы.Колонки.Добавить("СуммаПР", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	ТаблицаМатериалы.Колонки.Добавить("СуммаВР", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	
	Если ТаблицаМатериалы.Количество() = 0 Тогда
		Возврат ТаблицаМатериалы;
	КонецЕсли;
	
	ТаблицаСписанныеМатериалы.Свернуть("НомерСтроки", "СуммаСписания,СуммаСписанияНУ,СуммаСписанияПР,СуммаСписанияВР");
	
	Для каждого СтрокаТаблицы Из ТаблицаМатериалы Цикл
		
		Если СтрокаТаблицы.НомерСтроки > ТаблицаСписанныеМатериалы.Количество() Тогда
			Продолжить;
		КонецЕсли;
		
		СтрокаСписания = ТаблицаСписанныеМатериалы[СтрокаТаблицы.НомерСтроки - 1];
		
		Если СтрокаТаблицы.ИмяСписка = "ИнвентарьИХозяйственныеПринадлежности"
		 ИЛИ СтрокаТаблицы.СпособПогашенияСтоимости = Перечисления.СпособыПогашенияСтоимости.ПогашатьСтоимостьПриПередачеВЭксплуатацию
		Тогда
			СтрокаТаблицы.Сумма = СтрокаСписания.СуммаСписания;
		Иначе
			СтрокаТаблицы.Сумма = 0;
		КонецЕсли;
		
		Если СтрокаТаблицы.ИмяСписка = "ИнвентарьИХозяйственныеПринадлежности"
		 ИЛИ СтрокаТаблицы.СпособПогашенияСтоимостиНУ = Перечисления.СпособыПогашенияСтоимости.ПогашатьСтоимостьПриПередачеВЭксплуатацию
		Тогда
			СтрокаТаблицы.СуммаНУ = СтрокаСписания.СуммаСписанияНУ;
		Иначе
			СтрокаТаблицы.СуммаНУ = 0;
		КонецЕсли;
		
		СтрокаТаблицы.СуммаМЦ = СтрокаСписания.СуммаСписания;
		СтрокаТаблицы.СуммаМЦНУ = СтрокаСписания.СуммаСписанияНУ;
		СтрокаТаблицы.СуммаПР = СтрокаСписания.СуммаСписанияПР;
		СтрокаТаблицы.СуммаВР = СтрокаСписания.СуммаСписанияВР;
		
	КонецЦикла;
	
	Возврат ТаблицаМатериалы;

КонецФункции

Функция ПодготовитьТаблицуПереданныеВЭксплуатациюМатериалы2021(ТаблицаМатериалы, ТаблицаСписанныеМатериалы, Отказ)
	
	ОписаниеТипаЧисла15_2 = ОбщегоНазначения.ОписаниеТипаЧисло(15, 2);
	
	ТаблицаМатериалы.Колонки.Добавить("Сумма",     ОписаниеТипаЧисла15_2);
	ТаблицаМатериалы.Колонки.Добавить("СуммаМЦ",   ОписаниеТипаЧисла15_2);
	ТаблицаМатериалы.Колонки.Добавить("СуммаНУ",   ОписаниеТипаЧисла15_2);
	ТаблицаМатериалы.Колонки.Добавить("СуммаМЦНУ", ОписаниеТипаЧисла15_2);
	ТаблицаМатериалы.Колонки.Добавить("СуммаПР",   ОписаниеТипаЧисла15_2);
	ТаблицаМатериалы.Колонки.Добавить("СуммаВР",   ОписаниеТипаЧисла15_2);
	
	Если ТаблицаМатериалы.Количество() = 0 Тогда
		Возврат ТаблицаМатериалы;
	КонецЕсли;
	
	ТаблицаСписанныеМатериалы.Свернуть("НомерСтроки", "СуммаСписания,СуммаСписанияНУ,СуммаСписанияПР,СуммаСписанияВР");
	
	Для каждого СтрокаТаблицы Из ТаблицаМатериалы Цикл
		
		Если СтрокаТаблицы.НомерСтроки > ТаблицаСписанныеМатериалы.Количество() Тогда
			Продолжить;
		КонецЕсли;
		
		СтрокаСписания = ТаблицаСписанныеМатериалы[СтрокаТаблицы.НомерСтроки - 1];
		
		СтрокаТаблицы.Сумма = СтрокаСписания.СуммаСписания;
		СтрокаТаблицы.СуммаНУ = СтрокаСписания.СуммаСписанияНУ;
		СтрокаТаблицы.СуммаМЦ = СтрокаСписания.СуммаСписания;
		СтрокаТаблицы.СуммаМЦНУ = СтрокаСписания.СуммаСписанияНУ;
		СтрокаТаблицы.СуммаПР = СтрокаСписания.СуммаСписанияПР;
		СтрокаТаблицы.СуммаВР = СтрокаСписания.СуммаСписанияВР;
		
	КонецЦикла;
	
	Возврат ТаблицаМатериалы;

КонецФункции

// ПОДГОТОВКА ПОГАШЕНИЯ СТОИМОСТИ СПЕЦОДЕЖДЫ, СПЕЦОСНАСТКИ

Функция ПодготовитьТаблицуПогашениеСтоимостиСпецодеждыСпецоснастки(ТаблицаМатериалы = Неопределено, Реквизиты, Отказ)
	
	// Если это регламентная операция "Погашение стоимости спецодежды и спецоснастки",
	// будем формировать таблицу по всем материалам в эксплуатации
	ЭтоРегламентнаяОперация = (ТаблицаМатериалы = Неопределено);
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("Организация", Реквизиты.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоМесяца(Реквизиты.Период));
	
	Если ЭтоРегламентнаяОперация Тогда
		Запрос.УстановитьПараметр("КонецПериода", КонецМесяца(Реквизиты.Период));
	Иначе
		Запрос.УстановитьПараметр("КонецПериода", Новый Граница(Новый МоментВремени(Реквизиты.Период, Реквизиты.Регистратор), ВидГраницы.Исключая));
	КонецЕсли;
	
	Запрос.УстановитьПараметр("СчетаУчетаСпецодеждыЗабалансовый",   
		БухгалтерскийУчетПовтИсп.СчетаВИерархии(ПланыСчетов.Хозрасчетный.СпецодеждаВЭксплуатацииВспомогательный));
	Запрос.УстановитьПараметр("СчетаУчетаСпецоснасткиЗабалансовый", 
		БухгалтерскийУчетПовтИсп.СчетаВИерархии(ПланыСчетов.Хозрасчетный.СпецоснасткаВЭксплуатацииВспомогательный));
	Запрос.УстановитьПараметр("СчетаУчетаСпецодежды",              
		БухгалтерскийУчетПовтИсп.СчетаВИерархии(ПланыСчетов.Хозрасчетный.СпецодеждаВЭксплуатации));
	Запрос.УстановитьПараметр("СчетаУчетаСпецоснастки",            
		БухгалтерскийУчетПовтИсп.СчетаВИерархии(ПланыСчетов.Хозрасчетный.СпецоснасткаВЭксплуатации));
	
	ВидыСубконтоСпецодежда = Новый Массив;
	ВидыСубконтоСпецодежда.Добавить(ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.Номенклатура);
	ВидыСубконтоСпецодежда.Добавить(ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.ПартииМатериаловВЭксплуатации);
	ВидыСубконтоСпецодежда.Добавить(ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.РаботникиОрганизаций);
	
	ВидыСубконтоСпецоснастка = Новый Массив;
	ВидыСубконтоСпецоснастка.Добавить(ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.Номенклатура);
	ВидыСубконтоСпецоснастка.Добавить(ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.ПартииМатериаловВЭксплуатации);
	
	Запрос.УстановитьПараметр("ВидыСубконтоСпецодежда",   ВидыСубконтоСпецодежда);
	Запрос.УстановитьПараметр("ВидыСубконтоСпецоснастка", ВидыСубконтоСпецоснастка);
	
	Если ЭтоРегламентнаяОперация Тогда
		
		ТекстОтбораМатериалов = "";
		
	Иначе
		
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ВнешнийИсточник.СчетПередачи КАК СчетПередачи,
		|	ВнешнийИсточник.Номенклатура КАК Номенклатура,
		|	ВнешнийИсточник.ПартияМатериаловВЭксплуатации КАК ПартияМатериаловВЭксплуатации,
		|	ВнешнийИсточник.ФизЛицо КАК ФизЛицо,
		|	ВнешнийИсточник.Подразделение КАК Подразделение,
		|	ВнешнийИсточник.Количество
		|ПОМЕСТИТЬ ТаблицаНоменклатуры
		|ИЗ
		|	&ВнешнийИсточник КАК ВнешнийИсточник
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	СчетПередачи,
		|	Номенклатура,
		|	ПартияМатериаловВЭксплуатации,
		|	ФизЛицо,
		|	Подразделение
		|;
		|";
		Материалы = ТаблицаМатериалы.Скопировать();
		Материалы.Свернуть("СчетПередачи, Номенклатура, ПартияМатериаловВЭксплуатации, ФизЛицо, Подразделение", "Количество");
		Запрос.УстановитьПараметр("ВнешнийИсточник", Материалы);
		Запрос.УстановитьПараметр("СписокПартийМатериаловВЭксплуатации",
			ОбщегоНазначения.ВыгрузитьКолонку(Материалы, "ПартияМатериаловВЭксплуатации", Истина));
			
		ТекстОтбораМатериалов = " И Субконто1 В (ВЫБРАТЬ Номенклатура ИЗ ТаблицаНоменклатуры) И Субконто2 В (&СписокПартийМатериаловВЭксплуатации)";
		
	Конецесли;
	
	Запрос.Текст = Запрос.Текст + "
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ХозрасчетныйОстаткиИОборотыМЦ.Счет КАК СчетМЦ,
	|	ХозрасчетныйОстаткиИОборотыМЦ.Субконто1 КАК Номенклатура,
	|	ХозрасчетныйОстаткиИОборотыМЦ.Субконто2 КАК ПартияМатериаловВЭксплуатации,
	|	ХозрасчетныйОстаткиИОборотыМЦ.Субконто3 КАК ФизЛицо,
	|	ХозрасчетныйОстаткиИОборотыМЦ.Подразделение КАК Подразделение,
	|	ХозрасчетныйОстаткиИОборотыМЦ.КоличествоКонечныйОстатокДт КАК КоличествоКонечныйОстаток,
	|	ХозрасчетныйОстаткиИОборотыМЦ.СуммаКонечныйОстатокДт КАК ПервоначальнаяСтоимостьКонечныйОстаток,
	|	ХозрасчетныйОстаткиИОборотыМЦ.СуммаНУКонечныйОстатокДт КАК ПервоначальнаяСтоимостьНУКонечныйОстаток,	
	|	ХозрасчетныйОстаткиИОборотыМЦ.СуммаПРКонечныйОстатокДт КАК ПервоначальнаяСтоимостьПРКонечныйОстаток,
	|	ХозрасчетныйОстаткиИОборотыМЦ.СуммаВРКонечныйОстатокДт КАК ПервоначальнаяСтоимостьВРКонечныйОстаток
	|ПОМЕСТИТЬ СпецодеждаОстаткиМЦ
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.ОстаткиИОбороты(&НачалоПериода, &КонецПериода, Период, , Счет В (&СчетаУчетаСпецодеждыЗабалансовый), &ВидыСубконтоСпецодежда, Организация = &Организация"+ТекстОтбораМатериалов+") КАК ХозрасчетныйОстаткиИОборотыМЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ПартияМатериаловВЭксплуатации,
	|	ФизЛицо,
	|	Подразделение
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ХозрасчетныйОстаткиИОборотыМЦ.Счет КАК СчетМЦ,
	|	ХозрасчетныйОстаткиИОборотыМЦ.Субконто1 КАК Номенклатура,
	|	ХозрасчетныйОстаткиИОборотыМЦ.Субконто2 КАК ПартияМатериаловВЭксплуатации,
	|	ХозрасчетныйОстаткиИОборотыМЦ.Подразделение КАК Подразделение,
	|	ХозрасчетныйОстаткиИОборотыМЦ.КоличествоКонечныйОстатокДт КАК КоличествоКонечныйОстаток,
	|	ХозрасчетныйОстаткиИОборотыМЦ.СуммаКонечныйОстатокДт КАК ПервоначальнаяСтоимостьКонечныйОстаток,
	|	ХозрасчетныйОстаткиИОборотыМЦ.СуммаНУКонечныйОстатокДт КАК ПервоначальнаяСтоимостьНУКонечныйОстаток,
	|	ХозрасчетныйОстаткиИОборотыМЦ.СуммаПРКонечныйОстатокДт КАК ПервоначальнаяСтоимостьПРКонечныйОстаток,
	|	ХозрасчетныйОстаткиИОборотыМЦ.СуммаВРКонечныйОстатокДт КАК ПервоначальнаяСтоимостьВРКонечныйОстаток
	|ПОМЕСТИТЬ СпецоснасткаОстаткиМЦ
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.ОстаткиИОбороты(&НачалоПериода, &КонецПериода, Период, , Счет В (&СчетаУчетаСпецоснасткиЗабалансовый), &ВидыСубконтоСпецоснастка, Организация = &Организация"+ТекстОтбораМатериалов+") КАК ХозрасчетныйОстаткиИОборотыМЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ПартияМатериаловВЭксплуатации,
	|	Подразделение
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ХозрасчетныйОстаткиИОбороты.Счет КАК СчетПередачи,
	|	ХозрасчетныйОстаткиИОбороты.Субконто1 КАК Номенклатура,
	|	ХозрасчетныйОстаткиИОбороты.Субконто2 КАК ПартияМатериаловВЭксплуатации,
	|	ХозрасчетныйОстаткиИОбороты.Субконто3 КАК ФизЛицо,
	|	ХозрасчетныйОстаткиИОбороты.Подразделение КАК Подразделение,
	|	ХозрасчетныйОстаткиИОбороты.СуммаНачальныйОстатокДт КАК СтоимостьНачальныйОстаток,
	|	ХозрасчетныйОстаткиИОбороты.СуммаКонечныйОстатокДт КАК СтоимостьКонечныйОстаток,
	|	ХозрасчетныйОстаткиИОбороты.СуммаНУКонечныйОстатокДт КАК СтоимостьНУКонечныйОстаток,
	|	ХозрасчетныйОстаткиИОбороты.СуммаПРКонечныйОстатокДт КАК СтоимостьПРКонечныйОстаток,
	|	ХозрасчетныйОстаткиИОбороты.СуммаВРКонечныйОстатокДт КАК СтоимостьВРКонечныйОстаток,
	|	ХозрасчетныйОстаткиИОбороты.КоличествоКонечныйОстатокДт КАК КоличествоОстаток,
	|	СпецодеждаОстаткиМЦ.СчетМЦ КАК СчетМЦ,
	|	ЕСТЬNULL(СпецодеждаОстаткиМЦ.ПервоначальнаяСтоимостьКонечныйОстаток, 0) КАК ПервоначальнаяСтоимостьКонечныйОстаток,
	|	ЕСТЬNULL(СпецодеждаОстаткиМЦ.ПервоначальнаяСтоимостьНУКонечныйОстаток, 0) КАК ПервоначальнаяСтоимостьНУКонечныйОстаток,
	|	ЕСТЬNULL(СпецодеждаОстаткиМЦ.ПервоначальнаяСтоимостьПРКонечныйОстаток, 0) КАК ПервоначальнаяСтоимостьПРКонечныйОстаток,
	|	ЕСТЬNULL(СпецодеждаОстаткиМЦ.ПервоначальнаяСтоимостьВРКонечныйОстаток, 0) КАК ПервоначальнаяСтоимостьВРКонечныйОстаток,
	|	ЕСТЬNULL(" + ?(ЭтоРегламентнаяОперация, "ХозрасчетныйОстаткиИОбороты.КоличествоКонечныйОстатокДт", "ТаблицаНоменклатуры.Количество") + ", 0) КАК Количество
	|ПОМЕСТИТЬ СпецодеждаОстатки
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.ОстаткиИОбороты(&НачалоПериода, &КонецПериода, Период, , Счет В (&СчетаУчетаСпецодежды), &ВидыСубконтоСпецодежда, Организация = &Организация"+ТекстОтбораМатериалов+") КАК ХозрасчетныйОстаткиИОбороты";
	
	Если НЕ ЭтоРегламентнаяОперация Тогда
		
		Запрос.Текст = Запрос.Текст +"
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаНоменклатуры КАК ТаблицаНоменклатуры
		|		ПО ХозрасчетныйОстаткиИОбороты.Счет = ТаблицаНоменклатуры.СчетПередачи
		|			И ХозрасчетныйОстаткиИОбороты.Субконто1 = ТаблицаНоменклатуры.Номенклатура
		|			И ХозрасчетныйОстаткиИОбороты.Субконто2 = ТаблицаНоменклатуры.ПартияМатериаловВЭксплуатации
		|			И ХозрасчетныйОстаткиИОбороты.Субконто3 = ТаблицаНоменклатуры.ФизЛицо
		|			И (ХозрасчетныйОстаткиИОбороты.Подразделение = ТаблицаНоменклатуры.Подразделение
		|				ИЛИ ХозрасчетныйОстаткиИОбороты.Подразделение ЕСТЬ NULL )
		|";
		
	КонецЕсли;
	
	Запрос.Текст = Запрос.Текст +"
	|		ЛЕВОЕ СОЕДИНЕНИЕ СпецодеждаОстаткиМЦ КАК СпецодеждаОстаткиМЦ
	|		ПО ХозрасчетныйОстаткиИОбороты.Субконто1 = СпецодеждаОстаткиМЦ.Номенклатура
	|			И ХозрасчетныйОстаткиИОбороты.Субконто2 = СпецодеждаОстаткиМЦ.ПартияМатериаловВЭксплуатации
	|			И ХозрасчетныйОстаткиИОбороты.Субконто3 = СпецодеждаОстаткиМЦ.ФизЛицо
	|			И (ХозрасчетныйОстаткиИОбороты.Подразделение = СпецодеждаОстаткиМЦ.Подразделение
	|				ИЛИ ХозрасчетныйОстаткиИОбороты.Подразделение ЕСТЬ NULL )
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ПартияМатериаловВЭксплуатации,
	|	ФизЛицо,
	|	Подразделение
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ХозрасчетныйОстаткиИОбороты.Счет КАК СчетПередачи,
	|	ХозрасчетныйОстаткиИОбороты.Субконто1 КАК Номенклатура,
	|	ХозрасчетныйОстаткиИОбороты.Субконто2 КАК ПартияМатериаловВЭксплуатации,
	|	ХозрасчетныйОстаткиИОбороты.Подразделение КАК Подразделение,
	|	ХозрасчетныйОстаткиИОбороты.СуммаНачальныйОстатокДт КАК СтоимостьНачальныйОстаток,
	|	ХозрасчетныйОстаткиИОбороты.СуммаКонечныйОстатокДт КАК СтоимостьКонечныйОстаток,
	|	ХозрасчетныйОстаткиИОбороты.СуммаНУКонечныйОстатокДт КАК СтоимостьНУКонечныйОстаток,
	|	ХозрасчетныйОстаткиИОбороты.СуммаПРКонечныйОстатокДт КАК СтоимостьПРКонечныйОстаток,
	|	ХозрасчетныйОстаткиИОбороты.СуммаВРКонечныйОстатокДт КАК СтоимостьВРКонечныйОстаток,
	|	ХозрасчетныйОстаткиИОбороты.КоличествоКонечныйОстатокДт КАК КоличествоОстаток,
	|	СпецоснасткаОстаткиМЦ.СчетМЦ КАК СчетМЦ,
	|	ЕСТЬNULL(СпецоснасткаОстаткиМЦ.ПервоначальнаяСтоимостьКонечныйОстаток, 0) КАК ПервоначальнаяСтоимостьКонечныйОстаток,
	|	ЕСТЬNULL(СпецоснасткаОстаткиМЦ.ПервоначальнаяСтоимостьНУКонечныйОстаток, 0) КАК ПервоначальнаяСтоимостьНУКонечныйОстаток,
	|	ЕСТЬNULL(СпецоснасткаОстаткиМЦ.ПервоначальнаяСтоимостьПРКонечныйОстаток, 0) КАК ПервоначальнаяСтоимостьПРКонечныйОстаток,
	|	ЕСТЬNULL(СпецоснасткаОстаткиМЦ.ПервоначальнаяСтоимостьВРКонечныйОстаток, 0) КАК ПервоначальнаяСтоимостьВРКонечныйОстаток,
	|	ЕСТЬNULL(" + ?(ЭтоРегламентнаяОперация, "ХозрасчетныйОстаткиИОбороты.КоличествоКонечныйОстатокДт", "ТаблицаНоменклатуры.Количество") + ", 0) КАК Количество
	|ПОМЕСТИТЬ СпецоснасткаОстатки
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.ОстаткиИОбороты(&НачалоПериода, &КонецПериода, Период, , Счет В (&СчетаУчетаСпецоснастки), &ВидыСубконтоСпецоснастка, Организация = &Организация"+ТекстОтбораМатериалов+") КАК ХозрасчетныйОстаткиИОбороты";
	
	Если НЕ ЭтоРегламентнаяОперация Тогда
		
		Запрос.Текст = Запрос.Текст +"
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаНоменклатуры КАК ТаблицаНоменклатуры
		|		ПО ХозрасчетныйОстаткиИОбороты.Счет = ТаблицаНоменклатуры.СчетПередачи
		|			И ХозрасчетныйОстаткиИОбороты.Субконто1 = ТаблицаНоменклатуры.Номенклатура
		|			И ХозрасчетныйОстаткиИОбороты.Субконто2 = ТаблицаНоменклатуры.ПартияМатериаловВЭксплуатации
		|			И ХозрасчетныйОстаткиИОбороты.Подразделение = ТаблицаНоменклатуры.Подразделение
		|";
		
	КонецЕсли;
	
	Запрос.Текст = Запрос.Текст +"
	|		ЛЕВОЕ СОЕДИНЕНИЕ СпецоснасткаОстаткиМЦ КАК СпецоснасткаОстаткиМЦ
	|		ПО ХозрасчетныйОстаткиИОбороты.Субконто1 = СпецоснасткаОстаткиМЦ.Номенклатура
	|			И ХозрасчетныйОстаткиИОбороты.Субконто2 = СпецоснасткаОстаткиМЦ.ПартияМатериаловВЭксплуатации
	|			И ХозрасчетныйОстаткиИОбороты.Подразделение = СпецоснасткаОстаткиМЦ.Подразделение
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ПартияМатериаловВЭксплуатации,
	|	Подразделение
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВыработкаМатериаловОбороты.Номенклатура,
	|	ВыработкаМатериаловОбороты.КоличествоОборот
	|ПОМЕСТИТЬ ВыработкаМатериаловОбороты
	|ИЗ
	|	РегистрНакопления.ВыработкаМатериалов.Обороты(&НачалоПериода, &КонецПериода, Период, Организация = &Организация) КАК ВыработкаМатериаловОбороты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СпецодеждаОстатки.СчетПередачи,
	|	СпецодеждаОстатки.СчетМЦ,
	|	СпецодеждаОстатки.Номенклатура,
	|	СпецодеждаОстатки.ПартияМатериаловВЭксплуатации,
	|	СпецодеждаОстатки.ФизЛицо,
	|	СпецодеждаОстатки.Подразделение,
	|	СпецодеждаОстатки.СтоимостьНачальныйОстаток,
	|	СпецодеждаОстатки.СтоимостьКонечныйОстаток,
	|	СпецодеждаОстатки.СтоимостьНУКонечныйОстаток,
	|	СпецодеждаОстатки.СтоимостьПРКонечныйОстаток,
	|	СпецодеждаОстатки.СтоимостьВРКонечныйОстаток,
	|	СпецодеждаОстатки.КоличествоОстаток,
	|	СпецодеждаОстатки.ПервоначальнаяСтоимостьКонечныйОстаток,
	|	СпецодеждаОстатки.ПервоначальнаяСтоимостьНУКонечныйОстаток,
	|	СпецодеждаОстатки.ПервоначальнаяСтоимостьПРКонечныйОстаток,
	|	СпецодеждаОстатки.ПервоначальнаяСтоимостьВРКонечныйОстаток,
	|	СпецодеждаОстатки.Количество КАК КоличествоМЦ,
	|	СпецодеждаОстатки.Количество,
	|	ПередачаМатериаловВЭксплуатациюСпецодежда.НазначениеИспользования КАК НазначениеИспользования,
	|	ПередачаМатериаловВЭксплуатациюСпецодежда.НазначениеИспользования.СпособПогашенияСтоимости КАК СпособПогашенияСтоимости,
	|	ЕСТЬNULL(ПередачаМатериаловВЭксплуатациюСпецодежда.НазначениеИспользования.СрокПолезногоИспользования, 0) КАК СрокПолезногоИспользования,
	|	ЕСТЬNULL(ПередачаМатериаловВЭксплуатациюСпецодежда.НазначениеИспользования.ОбщийОбъемПродукцииРабот, 0) КАК ОбъемПродукцииРабот,
	|	ПередачаМатериаловВЭксплуатациюСпецодежда.НазначениеИспользования.СпособОтраженияРасходов КАК СпособОтраженияРасходов,
	|	0 КАК Выработка
	|ИЗ
	|	СпецодеждаОстатки КАК СпецодеждаОстатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаМатериаловВЭксплуатацию.Спецодежда КАК ПередачаМатериаловВЭксплуатациюСпецодежда
	|		ПО СпецодеждаОстатки.Номенклатура = ПередачаМатериаловВЭксплуатациюСпецодежда.Номенклатура
	|			И СпецодеждаОстатки.ПартияМатериаловВЭксплуатации = ПередачаМатериаловВЭксплуатациюСпецодежда.Ссылка
	|			И СпецодеждаОстатки.ФизЛицо = ПередачаМатериаловВЭксплуатациюСпецодежда.ФизЛицо
	|ГДЕ
	|	СпецодеждаОстатки.ПартияМатериаловВЭксплуатации ССЫЛКА Документ.ПередачаМатериаловВЭксплуатацию
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СпецодеждаОстатки.СчетПередачи,
	|	СпецодеждаОстатки.СчетМЦ,
	|	СпецодеждаОстатки.Номенклатура,
	|	СпецодеждаОстатки.ПартияМатериаловВЭксплуатации,
	|	СпецодеждаОстатки.ФизЛицо,
	|	СпецодеждаОстатки.Подразделение,
	|	СпецодеждаОстатки.СтоимостьНачальныйОстаток,
	|	СпецодеждаОстатки.СтоимостьКонечныйОстаток,
	|	СпецодеждаОстатки.СтоимостьНУКонечныйОстаток,
	|	СпецодеждаОстатки.СтоимостьПРКонечныйОстаток,
	|	СпецодеждаОстатки.СтоимостьВРКонечныйОстаток,
	|	СпецодеждаОстатки.КоличествоОстаток,
	|	СпецодеждаОстатки.ПервоначальнаяСтоимостьКонечныйОстаток,
	|	СпецодеждаОстатки.ПервоначальнаяСтоимостьНУКонечныйОстаток,
	|	СпецодеждаОстатки.ПервоначальнаяСтоимостьПРКонечныйОстаток,
	|	СпецодеждаОстатки.ПервоначальнаяСтоимостьВРКонечныйОстаток,
	|	СпецодеждаОстатки.Количество,
	|	СпецодеждаОстатки.Количество,
	|	ПартияМатериаловВЭксплуатацииСпецодежда.НазначениеИспользования,
	|	ПартияМатериаловВЭксплуатацииСпецодежда.НазначениеИспользования.СпособПогашенияСтоимости,
	|	ЕСТЬNULL(ПартияМатериаловВЭксплуатацииСпецодежда.НазначениеИспользования.СрокПолезногоИспользования, 0),
	|	ЕСТЬNULL(ПартияМатериаловВЭксплуатацииСпецодежда.НазначениеИспользования.ОбщийОбъемПродукцииРабот, 0),
	|	ПартияМатериаловВЭксплуатацииСпецодежда.НазначениеИспользования.СпособОтраженияРасходов,
	|	0
	|ИЗ
	|	СпецодеждаОстатки КАК СпецодеждаОстатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПартияМатериаловВЭксплуатации КАК ПартияМатериаловВЭксплуатацииСпецодежда
	|		ПО СпецодеждаОстатки.Номенклатура = ПартияМатериаловВЭксплуатацииСпецодежда.Номенклатура
	|			И СпецодеждаОстатки.ПартияМатериаловВЭксплуатации = ПартияМатериаловВЭксплуатацииСпецодежда.Ссылка
	|ГДЕ
	|	СпецодеждаОстатки.ПартияМатериаловВЭксплуатации ССЫЛКА Документ.ПартияМатериаловВЭксплуатации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СпецоснасткаОстатки.СчетПередачи,
	|	СпецоснасткаОстатки.СчетМЦ,
	|	СпецоснасткаОстатки.Номенклатура,
	|	СпецоснасткаОстатки.ПартияМатериаловВЭксплуатации,
	|	ЗНАЧЕНИЕ(Справочник.ФизическиеЛица.ПустаяСсылка),
	|	СпецоснасткаОстатки.Подразделение,
	|	СпецоснасткаОстатки.СтоимостьНачальныйОстаток,
	|	СпецоснасткаОстатки.СтоимостьКонечныйОстаток,
	|	СпецоснасткаОстатки.СтоимостьНУКонечныйОстаток,
	|	СпецоснасткаОстатки.СтоимостьПРКонечныйОстаток,
	|	СпецоснасткаОстатки.СтоимостьВРКонечныйОстаток,
	|	СпецоснасткаОстатки.КоличествоОстаток,
	|	СпецоснасткаОстатки.ПервоначальнаяСтоимостьКонечныйОстаток,
	|	СпецоснасткаОстатки.ПервоначальнаяСтоимостьНУКонечныйОстаток,
	|	СпецоснасткаОстатки.ПервоначальнаяСтоимостьПРКонечныйОстаток,
	|	СпецоснасткаОстатки.ПервоначальнаяСтоимостьВРКонечныйОстаток,
	|	СпецоснасткаОстатки.Количество,
	|	СпецоснасткаОстатки.Количество,
	|	ПередачаМатериаловВЭксплуатациюСпецоснастка.НазначениеИспользования,
	|	ПередачаМатериаловВЭксплуатациюСпецоснастка.НазначениеИспользования.СпособПогашенияСтоимости,
	|	ЕСТЬNULL(ПередачаМатериаловВЭксплуатациюСпецоснастка.НазначениеИспользования.СрокПолезногоИспользования, 0),
	|	ЕСТЬNULL(ПередачаМатериаловВЭксплуатациюСпецоснастка.НазначениеИспользования.ОбщийОбъемПродукцииРабот, 0),
	|	ПередачаМатериаловВЭксплуатациюСпецоснастка.НазначениеИспользования.СпособОтраженияРасходов,
	|	ЕСТЬNULL(ВыработкаМатериаловОбороты.КоличествоОборот, 0)
	|ИЗ
	|	СпецоснасткаОстатки КАК СпецоснасткаОстатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаМатериаловВЭксплуатацию.Спецоснастка КАК ПередачаМатериаловВЭксплуатациюСпецоснастка
	|		ПО СпецоснасткаОстатки.Номенклатура = ПередачаМатериаловВЭксплуатациюСпецоснастка.Номенклатура
	|			И СпецоснасткаОстатки.ПартияМатериаловВЭксплуатации = ПередачаМатериаловВЭксплуатациюСпецоснастка.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВыработкаМатериаловОбороты КАК ВыработкаМатериаловОбороты
	|		ПО СпецоснасткаОстатки.Номенклатура = ВыработкаМатериаловОбороты.Номенклатура
	|ГДЕ
	|	СпецоснасткаОстатки.ПартияМатериаловВЭксплуатации ССЫЛКА Документ.ПередачаМатериаловВЭксплуатацию
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СпецоснасткаОстатки.СчетПередачи,
	|	СпецоснасткаОстатки.СчетМЦ,
	|	СпецоснасткаОстатки.Номенклатура,
	|	СпецоснасткаОстатки.ПартияМатериаловВЭксплуатации,
	|	ЗНАЧЕНИЕ(Справочник.ФизическиеЛица.ПустаяСсылка),
	|	СпецоснасткаОстатки.Подразделение,
	|	СпецоснасткаОстатки.СтоимостьНачальныйОстаток,
	|	СпецоснасткаОстатки.СтоимостьКонечныйОстаток,
	|	СпецоснасткаОстатки.СтоимостьНУКонечныйОстаток,
	|	СпецоснасткаОстатки.СтоимостьПРКонечныйОстаток,
	|	СпецоснасткаОстатки.СтоимостьВРКонечныйОстаток,
	|	СпецоснасткаОстатки.КоличествоОстаток,
	|	СпецоснасткаОстатки.ПервоначальнаяСтоимостьКонечныйОстаток,
	|	СпецоснасткаОстатки.ПервоначальнаяСтоимостьНУКонечныйОстаток,
	|	СпецоснасткаОстатки.ПервоначальнаяСтоимостьПРКонечныйОстаток,
	|	СпецоснасткаОстатки.ПервоначальнаяСтоимостьВРКонечныйОстаток,
	|	СпецоснасткаОстатки.Количество,
	|	СпецоснасткаОстатки.Количество,
	|	ПартияМатериаловВЭксплуатацииСпецоснастка.НазначениеИспользования,
	|	ПартияМатериаловВЭксплуатацииСпецоснастка.НазначениеИспользования.СпособПогашенияСтоимости,
	|	ЕСТЬNULL(ПартияМатериаловВЭксплуатацииСпецоснастка.НазначениеИспользования.СрокПолезногоИспользования, 0),
	|	ЕСТЬNULL(ПартияМатериаловВЭксплуатацииСпецоснастка.НазначениеИспользования.ОбщийОбъемПродукцииРабот, 0),
	|	ПартияМатериаловВЭксплуатацииСпецоснастка.НазначениеИспользования.СпособОтраженияРасходов,
	|	ЕСТЬNULL(ВыработкаМатериаловОбороты.КоличествоОборот, 0)
	|ИЗ
	|	СпецоснасткаОстатки КАК СпецоснасткаОстатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПартияМатериаловВЭксплуатации КАК ПартияМатериаловВЭксплуатацииСпецоснастка
	|		ПО СпецоснасткаОстатки.Номенклатура = ПартияМатериаловВЭксплуатацииСпецоснастка.Номенклатура
	|			И СпецоснасткаОстатки.ПартияМатериаловВЭксплуатации = ПартияМатериаловВЭксплуатацииСпецоснастка.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВыработкаМатериаловОбороты КАК ВыработкаМатериаловОбороты
	|		ПО СпецоснасткаОстатки.Номенклатура = ВыработкаМатериаловОбороты.Номенклатура
	|ГДЕ
	|	СпецоснасткаОстатки.ПартияМатериаловВЭксплуатации ССЫЛКА Документ.ПартияМатериаловВЭксплуатации";
	
	ТаблицаПогашениеСтоимости = Запрос.Выполнить().Выгрузить();
	
	// Рассчитываем суммы погашения стоимости
	ТаблицаПогашениеСтоимости.Колонки.Добавить("Сумма",   ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	ТаблицаПогашениеСтоимости.Колонки.Добавить("СуммаНУ", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	ТаблицаПогашениеСтоимости.Колонки.Добавить("СуммаПР", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	ТаблицаПогашениеСтоимости.Колонки.Добавить("СуммаВР", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	
	// Отберем строки таблицы погашения стоимости, в которых есть что распределять
	СтрокиПогашениеСтоимостиДляРаспределения = Новый Массив;
	СпособыОтраженияРасходов                 = Новый Массив;
	
	Для Каждого СтрокаТаблицы Из ТаблицаПогашениеСтоимости Цикл
		
		Если (НЕ ЗначениеЗаполнено(СтрокаТаблицы.НазначениеИспользования))
			ИЛИ (СтрокаТаблицы.СпособПогашенияСтоимости = Перечисления.СпособыПогашенияСтоимости.ПогашатьСтоимостьПриПередачеВЭксплуатацию)
			ИЛИ (СтрокаТаблицы.СтоимостьНачальныйОстаток <= 0) Тогда
			// Материал не имеет остаточной стоимости на начало месяца
			// или списан на затраты при передаче - дополнительная обработка не требуется.
			Продолжить;
		КонецЕсли;
		
		СтрокиПогашениеСтоимостиДляРаспределения.Добавить(СтрокаТаблицы);
		Если СпособыОтраженияРасходов.Найти(СтрокаТаблицы.СпособОтраженияРасходов) = Неопределено Тогда
			СпособыОтраженияРасходов.Добавить(СтрокаТаблицы.СпособОтраженияРасходов);
		КонецЕсли;
		
	КонецЦикла;
	
	// Проверим, что корректно заполнены правила отражения расходов.
	НаправленияАмортизацииСОшибками = Справочники.СпособыОтраженияРасходовПоАмортизации.ПроверитьПриВыполненииРегламентнойОперации(
		Реквизиты.Регистратор,
		Отказ,
		СпособыОтраженияРасходов);
	
	Для Каждого СтрокаТаблицы Из СтрокиПогашениеСтоимостиДляРаспределения Цикл
		
		Если (СтрокаТаблицы.СпособПогашенияСтоимости = Перечисления.СпособыПогашенияСтоимости.ПогашатьСтоимостьПриПередачеВЭксплуатацию)
			ИЛИ (СтрокаТаблицы.СтоимостьНачальныйОстаток <= 0) Тогда
			// Материал не имеет остаточной стоимости на начало месяца
			// или списан на затраты при передаче - дополнительная обработка не требуется.
			Продолжить;
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(СтрокаТаблицы.СпособПогашенияСтоимости) Тогда
			ТекстОшибки = НСтр("ru='Не указан способ погашения стоимости для материала ""%1"" в назначении использования ""%2"".
				|Рекомендуется проверить данные в документе передачи в эксплуатацию.'");
			ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				ТекстОшибки,
				СтрокаТаблицы.Номенклатура,
				СтрокаТаблицы.НазначениеИспользования);
			БухгалтерскийУчетПереопределяемый.СообщитьОбОшибкеРегОперацииСНавигацией(ТекстОшибки, , Отказ, Реквизиты.Регистратор);
			Продолжить;
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(СтрокаТаблицы.СрокПолезногоИспользования)
			И (СтрокаТаблицы.СпособПогашенияСтоимости = Перечисления.СпособыПогашенияСтоимости.Линейный) Тогда
				ТекстОшибки = НСтр("ru='Не указан срок использования для материала ""%1"" в назначении использования ""%2"".
					|Рекомендуется проверить данные в документе передачи в эксплуатацию.'");
				ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					ТекстОшибки,
					СтрокаТаблицы.Номенклатура,
					СтрокаТаблицы.НазначениеИспользования);
				БухгалтерскийУчетПереопределяемый.СообщитьОбОшибкеРегОперацииСНавигацией(ТекстОшибки, , Отказ, Реквизиты.Регистратор);
			Продолжить;
		КонецЕсли;
		
		СуммаПогашения   = 0;
		СуммаПогашенияНУ = 0;
		СуммаПогашенияПР = 0;
		
		Если СтрокаТаблицы.КоличествоОстаток > 0 Тогда
		
			Если СтрокаТаблицы.СпособПогашенияСтоимости = Перечисления.СпособыПогашенияСтоимости.Линейный Тогда
				
				СуммаПогашения   = СтрокаТаблицы.ПервоначальнаяСтоимостьКонечныйОстаток / СтрокаТаблицы.СрокПолезногоИспользования;
				СуммаПогашенияНУ = СтрокаТаблицы.ПервоначальнаяСтоимостьНУКонечныйОстаток / СтрокаТаблицы.СрокПолезногоИспользования;
				СуммаПогашенияПР = СтрокаТаблицы.ПервоначальнаяСтоимостьПРКонечныйОстаток / СтрокаТаблицы.СрокПолезногоИспользования;
				
			ИначеЕсли СтрокаТаблицы.СпособПогашенияСтоимости = Перечисления.СпособыПогашенияСтоимости.ПропорциональноОбъемуПродукцииРабот Тогда
				
				Если НЕ ЗначениеЗаполнено(СтрокаТаблицы.Выработка) Тогда
					Продолжить;
				КонецЕсли;
				
				Если НЕ ЗначениеЗаполнено(СтрокаТаблицы.ОбъемПродукцииРабот) Тогда
					ТекстОшибки = НСтр("ru='Не определен объем продукции для вычисления погашения стоимости для материала  ""%1"" в назначении использования ""%2"".
						|Рекомендуется проверить данные в документе передачи в эксплуатацию.'");
					ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						ТекстОшибки,
						СтрокаТаблицы.Номенклатура,
						СтрокаТаблицы.НазначениеИспользования);
					БухгалтерскийУчетПереопределяемый.СообщитьОбОшибкеРегОперацииСНавигацией(ТекстОшибки, , Отказ, Реквизиты.Регистратор);
					Продолжить;
				КонецЕсли;
				
				СуммаПогашения   = СтрокаТаблицы.ПервоначальнаяСтоимостьКонечныйОстаток * СтрокаТаблицы.Выработка / СтрокаТаблицы.ОбъемПродукцииРабот;
				СуммаПогашенияНУ = СтрокаТаблицы.ПервоначальнаяСтоимостьНУКонечныйОстаток * СтрокаТаблицы.Выработка / СтрокаТаблицы.ОбъемПродукцииРабот;
				СуммаПогашенияПР = СтрокаТаблицы.ПервоначальнаяСтоимостьПРКонечныйОстаток * СтрокаТаблицы.Выработка / СтрокаТаблицы.ОбъемПродукцииРабот;
				
			КонецЕсли;
			
			// Сумма погашения рассчитывается пропорционально количеству материалов, по которым погашается стоимость.
			СуммаПогашения   = СуммаПогашения / СтрокаТаблицы.КоличествоОстаток * СтрокаТаблицы.Количество;
			СуммаПогашенияНУ = СуммаПогашенияНУ / СтрокаТаблицы.КоличествоОстаток * СтрокаТаблицы.Количество;
			СуммаПогашенияПР = СуммаПогашенияПР / СтрокаТаблицы.КоличествоОстаток * СтрокаТаблицы.Количество;
			
			СуммаПогашения = ?(Окр(СуммаПогашения, 2) = 0 И СуммаПогашения <> 0, 0.01, Окр(СуммаПогашения, 2));
			СуммаПогашенияНУ = ?(Окр(СуммаПогашенияНУ, 2) = 0 И СуммаПогашенияНУ <> 0, 0.01, Окр(СуммаПогашенияНУ, 2));
			СуммаПогашенияПР = ?(Окр(СуммаПогашенияПР, 2) = 0 И СуммаПогашенияПР <> 0, 0.01, Окр(СуммаПогашенияПР, 2));
			
		КонецЕсли;
		
		// Сумма погашения не может быть меньше 0 и больше остаточной стоимости.
		СтрокаТаблицы.Сумма   = Макс(0, Мин(СтрокаТаблицы.СтоимостьКонечныйОстаток, СуммаПогашения));
		СтрокаТаблицы.СуммаНУ = Макс(0, Мин(СтрокаТаблицы.СтоимостьНУКонечныйОстаток, СуммаПогашенияНУ));
		СтрокаТаблицы.СуммаПР = Макс(0, Мин(СтрокаТаблицы.СтоимостьПРКонечныйОстаток, СуммаПогашенияПР));
		
		Если СтрокаТаблицы.Сумма = 0 И СтрокаТаблицы.СуммаНУ = 0 И СтрокаТаблицы.СуммаПР = 0 Тогда
			СтрокаТаблицы.СуммаВР = СтрокаТаблицы.СтоимостьВРКонечныйОстаток;
		Иначе
			СтрокаТаблицы.СуммаВР = СтрокаТаблицы.Сумма - СтрокаТаблицы.СуммаНУ - СтрокаТаблицы.СуммаПР;
		КонецЕсли;
		
	КонецЦикла;
	
	// Погашается только стоимость материалов, количество не списывается
	ТаблицаПогашениеСтоимости.ЗаполнитьЗначения(0, "Количество");
	ТаблицаПогашениеСтоимости.ЗаполнитьЗначения(0, "КоличествоМЦ");
	
	Возврат ТаблицаПогашениеСтоимости;
	
КонецФункции

Функция ПодготовитьТаблицуНачислениеПогашенияСтоимостиСпецодеждыСпецоснастки(ТаблицаМатериалы, Реквизиты, Отказ) Экспорт
	
	ТаблицаНачислениеПогашенияСтоимости = ТаблицаМатериалы.СкопироватьКолонки();
	ТаблицаНачислениеПогашенияСтоимости.Колонки.Добавить("СчетРасходов");
	ТаблицаНачислениеПогашенияСтоимости.Колонки.Добавить("СубконтоРасходов1");
	ТаблицаНачислениеПогашенияСтоимости.Колонки.Добавить("СубконтоРасходов2");
	ТаблицаНачислениеПогашенияСтоимости.Колонки.Добавить("СубконтоРасходов3");
	ТаблицаНачислениеПогашенияСтоимости.Колонки.Добавить("ПодразделениеРасходов");
	
	МассивКоэффициентов = Новый Массив;
	
	НаличиеСуммаМЦ = (ТаблицаМатериалы.Колонки.Найти("СуммаМЦ") <> Неопределено);
	НаличиеСуммаМЦНУ = (ТаблицаМатериалы.Колонки.Найти("СуммаМЦНУ") <> Неопределено);
	
	Для Каждого СтрокаТаблицы Из ТаблицаМатериалы Цикл
		
		Если СтрокаТаблицы.Количество = 0
		   И СтрокаТаблицы.КоличествоМЦ = 0
		   И СтрокаТаблицы.Сумма = 0
		   И СтрокаТаблицы.СуммаНУ = 0
		   И СтрокаТаблицы.СуммаПР = 0
		   И СтрокаТаблицы.СуммаВР = 0
		   И ?(НаличиеСуммаМЦ, СтрокаТаблицы.СуммаМЦ = 0, Истина)
		   И ?(НаличиеСуммаМЦНУ, СтрокаТаблицы.СуммаМЦНУ = 0, Истина)
		Тогда
			Продолжить;
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(СтрокаТаблицы.СпособОтраженияРасходов) Тогда
			ТекстОшибки = НСтр("ru='Не указан способ отражения расходов по погашению стоимости для материала ""%1"".
				|Рекомендуется проверить данные в документе передачи в эксплуатацию.'");
			ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				ТекстОшибки,
				СтрокаТаблицы.Номенклатура);
			БухгалтерскийУчетПереопределяемый.СообщитьОбОшибкеРегОперацииСНавигацией(ТекстОшибки, , Отказ, Реквизиты.Регистратор);
			Продолжить;
		КонецЕсли;

		МассивКоэффициентов.Очистить();
		Для Каждого СпособОтраженияРасходов Из СтрокаТаблицы.СпособОтраженияРасходов.Способы Цикл
			МассивКоэффициентов.Добавить(СпособОтраженияРасходов.Коэффициент);
		КонецЦикла;

		МассивКоличества = ОбщегоНазначенияБПКлиентСервер.РаспределитьПропорционально(СтрокаТаблицы.Количество, МассивКоэффициентов, 3);
		МассивКоличестваМЦ = ОбщегоНазначенияБПКлиентСервер.РаспределитьПропорционально(СтрокаТаблицы.КоличествоМЦ, МассивКоэффициентов, 3);

		Если НаличиеСуммаМЦ Тогда 
			МассивСуммМЦ = ОбщегоНазначенияБПКлиентСервер.РаспределитьПропорционально(СтрокаТаблицы.СуммаМЦ, МассивКоэффициентов, 2);
		Иначе
			МассивСуммМЦ = Неопределено;
		КонецЕсли;
		Если НаличиеСуммаМЦНУ Тогда 
			МассивСуммМЦНУ = ОбщегоНазначенияБПКлиентСервер.РаспределитьПропорционально(СтрокаТаблицы.СуммаМЦНУ, МассивКоэффициентов, 2);
		Иначе
			МассивСуммМЦНУ = Неопределено;
		КонецЕсли;
		
		МассивСумм = ОбщегоНазначенияБПКлиентСервер.РаспределитьПропорционально(СтрокаТаблицы.Сумма, МассивКоэффициентов, 2);
		Если ЗначениеЗаполнено(СтрокаТаблицы.Сумма) И (МассивСумм = Неопределено) Тогда
			ТекстОшибки = НСтр("ru='В способе отражения расходов по погашению стоимости для материала ""%1"" не проставлены коэффициенты.
				|Рекомендуется проверить данные в документе передачи в эксплуатацию.'");
			ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				ТекстОшибки,
				СтрокаТаблицы.Номенклатура);
			БухгалтерскийУчетПереопределяемый.СообщитьОбОшибкеРегОперацииСНавигацией(ТекстОшибки, , Отказ, Реквизиты.Регистратор);
			Продолжить;
		КонецЕсли;
		
		МассивСуммНУ = ОбщегоНазначенияБПКлиентСервер.РаспределитьПропорционально(СтрокаТаблицы.СуммаНУ, МассивКоэффициентов, 2);
		Если ЗначениеЗаполнено(СтрокаТаблицы.СуммаНУ) И (МассивСуммНУ = Неопределено) Тогда
			ТекстОшибки = НСтр("ru='В способе отражения расходов по погашению стоимости для материала ""%1"" не проставлены коэффициенты.
				|Рекомендуется проверить данные в документе передачи в эксплуатацию.'");
			ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				ТекстОшибки,
				СтрокаТаблицы.Номенклатура);
			БухгалтерскийУчетПереопределяемый.СообщитьОбОшибкеРегОперацииСНавигацией(ТекстОшибки, , Отказ, Реквизиты.Регистратор);
			Продолжить;
		КонецЕсли;
		
		МассивСуммПР = ОбщегоНазначенияБПКлиентСервер.РаспределитьПропорционально(СтрокаТаблицы.СуммаПР, МассивКоэффициентов, 2);
		Если ЗначениеЗаполнено(СтрокаТаблицы.СуммаПР) И (МассивСуммПР = Неопределено) Тогда
			ТекстОшибки = НСтр("ru='В способе отражения расходов по погашению стоимости для материала ""%1"" не проставлены коэффициенты.
				|Рекомендуется проверить данные в документе передачи в эксплуатацию.'");
			ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				ТекстОшибки,
				СтрокаТаблицы.Номенклатура);
			БухгалтерскийУчетПереопределяемый.СообщитьОбОшибкеРегОперацииСНавигацией(ТекстОшибки, , Отказ, Реквизиты.Регистратор);
			Продолжить;
		КонецЕсли;
		
		МассивСуммВР = ОбщегоНазначенияБПКлиентСервер.РаспределитьПропорционально(СтрокаТаблицы.СуммаВР, МассивКоэффициентов, 2);
		Если ЗначениеЗаполнено(СтрокаТаблицы.СуммаВР) И (МассивСуммВР = Неопределено) Тогда
			ТекстОшибки = НСтр("ru='В способе отражения расходов по погашению стоимости для материала ""%1"" не проставлены коэффициенты.
				|Рекомендуется проверить данные в документе передачи в эксплуатацию.'");
			ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				ТекстОшибки,
				СтрокаТаблицы.Номенклатура);
			БухгалтерскийУчетПереопределяемый.СообщитьОбОшибкеРегОперацииСНавигацией(ТекстОшибки, , Отказ, Реквизиты.Регистратор);
			Продолжить;
		КонецЕсли;
		
		Если НЕ (МассивСумм = Неопределено) Тогда
			Если МассивСумм.Количество() <> МассивКоэффициентов.Количество() Тогда
				ТекстОшибки = НСтр("ru='В способе отражения расходов по погашению стоимости для материала ""%1"" не проставлены коэффициенты.
					|Рекомендуется проверить данные в документе передачи в эксплуатацию.'");
				ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					ТекстОшибки,
					СтрокаТаблицы.Номенклатура);
				БухгалтерскийУчетПереопределяемый.СообщитьОбОшибкеРегОперацииСНавигацией(ТекстОшибки, , Отказ, Реквизиты.Регистратор);
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		
		Если НЕ (МассивСуммНУ = Неопределено) Тогда
			Если МассивСуммНУ.Количество() <> МассивКоэффициентов.Количество() Тогда
				ТекстОшибки = НСтр("ru='В способе отражения расходов по погашению стоимости для материала ""%1"" не проставлены коэффициенты.
					|Рекомендуется проверить данные в документе передачи в эксплуатацию.'");
				ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					ТекстОшибки,
					СтрокаТаблицы.Номенклатура);
				БухгалтерскийУчетПереопределяемый.СообщитьОбОшибкеРегОперацииСНавигацией(ТекстОшибки, , Отказ, Реквизиты.Регистратор);
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		
		Если НЕ (МассивСуммПР = Неопределено) Тогда
			Если МассивСуммПР.Количество() <> МассивКоэффициентов.Количество() Тогда
				ТекстОшибки = НСтр("ru='В способе отражения расходов по погашению стоимости для материала ""%1"" не проставлены коэффициенты.
					|Рекомендуется проверить данные в документе передачи в эксплуатацию.'");
				ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					ТекстОшибки,
					СтрокаТаблицы.Номенклатура);
				БухгалтерскийУчетПереопределяемый.СообщитьОбОшибкеРегОперацииСНавигацией(ТекстОшибки, , Отказ, Реквизиты.Регистратор);
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		
		Если НЕ (МассивСуммВР = Неопределено) Тогда
			Если МассивСуммВР.Количество() <> МассивКоэффициентов.Количество() Тогда
				ТекстОшибки = НСтр("ru='В способе отражения расходов по погашению стоимости для материала ""%1"" не проставлены коэффициенты.
					|Рекомендуется проверить данные в документе передачи в эксплуатацию.'");
				ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					ТекстОшибки,
					СтрокаТаблицы.Номенклатура);
				БухгалтерскийУчетПереопределяемый.СообщитьОбОшибкеРегОперацииСНавигацией(ТекстОшибки, , Отказ, Реквизиты.Регистратор);
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		
		Для Каждого СпособОтраженияРасходов Из СтрокаТаблицы.СпособОтраженияРасходов.Способы Цикл
			
			ИндексЭлемента = СпособОтраженияРасходов.НомерСтроки - 1;
			
			НоваяСтрока = ТаблицаНачислениеПогашенияСтоимости.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТаблицы);
			
			НоваяСтрока.СчетРасходов          = СпособОтраженияРасходов.СчетЗатрат;
			НоваяСтрока.ПодразделениеРасходов = СпособОтраженияРасходов.ПодразделениеОрганизации;
			НоваяСтрока.СубконтоРасходов1     = СпособОтраженияРасходов.Субконто1;
			НоваяСтрока.СубконтоРасходов2     = СпособОтраженияРасходов.Субконто2;
			НоваяСтрока.СубконтоРасходов3     = СпособОтраженияРасходов.Субконто3;
			НоваяСтрока.Сумма                 = ?(ЗначениеЗаполнено(МассивСумм),         МассивСумм[ИндексЭлемента],         0);
			НоваяСтрока.СуммаНУ               = ?(ЗначениеЗаполнено(МассивСуммНУ),       МассивСуммНУ[ИндексЭлемента],       0);
			НоваяСтрока.СуммаПР               = ?(ЗначениеЗаполнено(МассивСуммПР),       МассивСуммПР[ИндексЭлемента],       0);
			НоваяСтрока.СуммаВР               = ?(ЗначениеЗаполнено(МассивСуммВР),       МассивСуммВР[ИндексЭлемента],       0);
			НоваяСтрока.Количество            = ?(ЗначениеЗаполнено(МассивКоличества),   МассивКоличества[ИндексЭлемента],   0);
			НоваяСтрока.КоличествоМЦ          = ?(ЗначениеЗаполнено(МассивКоличестваМЦ), МассивКоличестваМЦ[ИндексЭлемента], 0);
			Если НаличиеСуммаМЦ Тогда
				НоваяСтрока.СуммаМЦ			  = ?(ЗначениеЗаполнено(МассивСуммМЦ),		 МассивСуммМЦ[ИндексЭлемента],		 0);
			КонецЕсли;
			Если НаличиеСуммаМЦНУ Тогда
				НоваяСтрока.СуммаМЦНУ		  = ?(ЗначениеЗаполнено(МассивСуммМЦНУ),	 МассивСуммМЦНУ[ИндексЭлемента],	 0);
			КонецЕсли;
			
		КонецЦикла;

	КонецЦикла;
	
	Возврат ТаблицаНачислениеПогашенияСтоимости;

КонецФункции

// ПОДГОТОВКА СПИСАНИЯ МАТЕРИАЛОВ ИЗ ЭКСПЛУАТАЦИИ

Функция ПодготовитьТаблицуСписанныеИзЭксплуатацииСпецодеждаСпецоснастка(ТаблицаМатериалы, ТаблицаПогашениеСтоимостиМатериалов, Реквизиты, Отказ)
	
	ВидОперацииСписания = ?(ТипЗнч(Реквизиты.Регистратор)=Тип("ДокументСсылка.ВозвратМатериаловИзЭксплуатации"), "Возврат", "Списание");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТаблицаМатериалы.ИмяСписка,
	|	ТаблицаМатериалы.СинонимСписка,
	|	ТаблицаМатериалы.НомерСтроки,
	|	ТаблицаМатериалы.СчетПередачи КАК СчетПередачи,
	|	ТаблицаМатериалы.СчетМЦ КАК СчетМЦ,
	|	ТаблицаМатериалы.Номенклатура КАК Номенклатура,
	|	ТаблицаМатериалы.ПартияМатериаловВЭксплуатации КАК ПартияМатериаловВЭксплуатации,
	|	ЕСТЬNULL(ТаблицаМатериалы.ФизЛицо, ЗНАЧЕНИЕ(Справочник.ФизическиеЛица.ПустаяСсылка)) КАК ФизЛицо,
	|	ЕСТЬNULL(ТаблицаМатериалы.Подразделение, &ПустоеПодразделение) КАК Подразделение,
	|	ТаблицаМатериалы.Количество,
	|	ТаблицаМатериалы.СчетРасходов,
	|	ТаблицаМатериалы.СубконтоРасходов1,
	|	ТаблицаМатериалы.СубконтоРасходов2,
	|	ТаблицаМатериалы.СубконтоРасходов3,
	|	ТаблицаМатериалы.ВидСубконтоРасходов1,
	|	ТаблицаМатериалы.ВидСубконтоРасходов2,
	|	ТаблицаМатериалы.ВидСубконтоРасходов3,
	|	ТаблицаМатериалы.Содержание
	|ПОМЕСТИТЬ ТаблицаМатериалы
	|ИЗ
	|	&ТаблицаМатериалы КАК ТаблицаМатериалы
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СчетПередачи,
	|	СчетМЦ,
	|	Номенклатура,
	|	ПартияМатериаловВЭксплуатации,
	|	ФизЛицо
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаПогашениеСтоимостиМатериалов.СчетПередачи КАК СчетПередачи,
	|	ТаблицаПогашениеСтоимостиМатериалов.СчетМЦ КАК СчетМЦ,
	|	ТаблицаПогашениеСтоимостиМатериалов.Номенклатура КАК Номенклатура,
	|	ТаблицаПогашениеСтоимостиМатериалов.ПартияМатериаловВЭксплуатации КАК ПартияМатериаловВЭксплуатации,
	|	ЕСТЬNULL(ТаблицаПогашениеСтоимостиМатериалов.ФизЛицо, ЗНАЧЕНИЕ(Справочник.ФизическиеЛица.ПустаяСсылка)) КАК ФизЛицо,
	|	ТаблицаПогашениеСтоимостиМатериалов.Подразделение КАК Подразделение,
	|	ТаблицаПогашениеСтоимостиМатериалов.СпособПогашенияСтоимости КАК СпособПогашенияСтоимости,
	|	ТаблицаПогашениеСтоимостиМатериалов.СпособОтраженияРасходов КАК СпособОтраженияРасходов,
	|	ТаблицаПогашениеСтоимостиМатериалов.КоличествоОстаток,
	|	ТаблицаПогашениеСтоимостиМатериалов.СтоимостьКонечныйОстаток,
	|	ТаблицаПогашениеСтоимостиМатериалов.СтоимостьНУКонечныйОстаток,
	|	ТаблицаПогашениеСтоимостиМатериалов.СтоимостьПРКонечныйОстаток,
	|	ТаблицаПогашениеСтоимостиМатериалов.СтоимостьВРКонечныйОстаток,
	|	ТаблицаПогашениеСтоимостиМатериалов.Сумма,
	|	ТаблицаПогашениеСтоимостиМатериалов.СуммаНУ,
	|	ТаблицаПогашениеСтоимостиМатериалов.СуммаПР,
	|	ТаблицаПогашениеСтоимостиМатериалов.СуммаВР
	|ПОМЕСТИТЬ ТаблицаПогашениеСтоимостиМатериалов
	|ИЗ
	|	&ТаблицаПогашениеСтоимостиМатериалов КАК ТаблицаПогашениеСтоимостиМатериалов
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СчетПередачи,
	|	СчетМЦ,
	|	Номенклатура,
	|	ПартияМатериаловВЭксплуатации,
	|	ФизЛицо
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаМатериалы.ИмяСписка КАК ИмяСписка,
	|	ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура) КАК ВидРасхода,
	|	ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.Купленные) КАК СтатусыПартийУСН,
	|	ТаблицаМатериалы.Номенклатура КАК ЭлементРасхода,
	|	ЛОЖЬ КАК ЭтоТовар,
	|	ИСТИНА КАК ЭтоМатериал,
	|	&ВалютаРегламентированногоУчета КАК Валюта,
	|	ТаблицаМатериалы.СинонимСписка,
	|	ТаблицаМатериалы.НомерСтроки КАК НомерСтроки,
	|	ТаблицаМатериалы.СчетПередачи,
	|	ТаблицаМатериалы.СчетМЦ,
	|	ТаблицаМатериалы.Номенклатура,
	|	ТаблицаМатериалы.ПартияМатериаловВЭксплуатации,
	|	ТаблицаМатериалы.ПартияМатериаловВЭксплуатации КАК Партия,
	|	ТаблицаМатериалы.ФизЛицо,
	|	ТаблицаМатериалы.ФизЛицо КАК ДоговорКонтрагента,
	|	&Подразделение КАК Подразделение,
	|	&Подразделение КАК ПодразделениеРасходов,
	|	ТаблицаМатериалы.Количество,
	|	ТаблицаМатериалы.Количество КАК КоличествоМЦ,
	|	0 КАК НДС,
	|	ТаблицаМатериалы.СчетРасходов КАК СчетУчета,
	|	ТаблицаМатериалы.СчетРасходов,
	|	ТаблицаМатериалы.СубконтоРасходов1,
	|	ТаблицаМатериалы.СубконтоРасходов2,
	|	ТаблицаМатериалы.СубконтоРасходов3,
	|	ТаблицаМатериалы.ВидСубконтоРасходов1,
	|	ТаблицаМатериалы.ВидСубконтоРасходов2,
	|	ТаблицаМатериалы.ВидСубконтоРасходов3,
	|	ТаблицаМатериалы.Содержание,
	|	ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.НеПринимаются) КАК ОтражениеВУСН,
	|	ТаблицаПогашениеСтоимостиМатериалов.СпособПогашенияСтоимости КАК СпособПогашенияСтоимости,
	|	ТаблицаПогашениеСтоимостиМатериалов.СпособОтраженияРасходов КАК СпособОтраженияРасходов,
	|	ЕСТЬNULL(ТаблицаПогашениеСтоимостиМатериалов.КоличествоОстаток, 0) КАК КоличествоОстаток,
	|	ЕСТЬNULL(ТаблицаПогашениеСтоимостиМатериалов.СтоимостьКонечныйОстаток, 0) КАК СтоимостьКонечныйОстаток,
	|	ЕСТЬNULL(ТаблицаПогашениеСтоимостиМатериалов.СтоимостьНУКонечныйОстаток, 0) КАК СтоимостьНУКонечныйОстаток,
	|	ЕСТЬNULL(ТаблицаПогашениеСтоимостиМатериалов.СтоимостьПРКонечныйОстаток, 0) КАК СтоимостьПРКонечныйОстаток,
	|	ЕСТЬNULL(ТаблицаПогашениеСтоимостиМатериалов.СтоимостьВРКонечныйОстаток, 0) КАК СтоимостьВРКонечныйОстаток,
	|	ЕСТЬNULL(ТаблицаПогашениеСтоимостиМатериалов.Сумма, 0) КАК СуммаПогашения,
	|	ЕСТЬNULL(ТаблицаПогашениеСтоимостиМатериалов.СуммаНУ, 0) КАК СуммаПогашенияНУ,
	|	ЕСТЬNULL(ТаблицаПогашениеСтоимостиМатериалов.СуммаПР, 0) КАК СуммаПогашенияПР,
	|	ЕСТЬNULL(ТаблицаПогашениеСтоимостиМатериалов.СуммаВР, 0) КАК СуммаПогашенияВР,
	|	ВЫБОР
	|		КОГДА ТаблицаМатериалы.ИмяСписка = ""Спецодежда""
	|			ТОГДА ЕСТЬNULL(ХозрасчетныйОстаткиСпецодежда.КоличествоОстатокДт, 0)
	|		ИНАЧЕ ЕСТЬNULL(ХозрасчетныйОстаткиСпецоснастка.КоличествоОстатокДт, 0)
	|	КОНЕЦ КАК КоличествоМЦОстаток,
	|	ВЫБОР
	|		КОГДА ТаблицаМатериалы.ИмяСписка = ""Спецодежда""
	|			ТОГДА ЕСТЬNULL(ХозрасчетныйОстаткиСпецодежда.СуммаОстатокДт, 0)
	|		ИНАЧЕ ЕСТЬNULL(ХозрасчетныйОстаткиСпецоснастка.СуммаОстатокДт, 0)
	|	КОНЕЦ КАК ПервоначальнаяСтоимостьКонечныйОстаток,
	|	ВЫБОР
	|		КОГДА ТаблицаМатериалы.ИмяСписка = ""Спецодежда""
	|			ТОГДА ЕСТЬNULL(ХозрасчетныйОстаткиСпецодежда.СуммаНУОстатокДт, 0)
	|		ИНАЧЕ ЕСТЬNULL(ХозрасчетныйОстаткиСпецоснастка.СуммаНУОстатокДт, 0)
	|	КОНЕЦ КАК ПервоначальнаяСтоимостьНУКонечныйОстаток,
	|	ВЫБОР
	|		КОГДА ТаблицаМатериалы.ИмяСписка = ""Спецодежда""
	|			ТОГДА ЕСТЬNULL(ХозрасчетныйОстаткиСпецодежда.СуммаПРОстатокДт, 0)
	|		ИНАЧЕ ЕСТЬNULL(ХозрасчетныйОстаткиСпецоснастка.СуммаПРОстатокДт, 0)
	|	КОНЕЦ КАК ПервоначальнаяСтоимостьПРКонечныйОстаток,
	|	ВЫБОР
	|		КОГДА ТаблицаМатериалы.ИмяСписка = ""Спецодежда""
	|			ТОГДА ЕСТЬNULL(ХозрасчетныйОстаткиСпецодежда.СуммаВРОстатокДт, 0)
	|		ИНАЧЕ ЕСТЬNULL(ХозрасчетныйОстаткиСпецоснастка.СуммаВРОстатокДт, 0)
	|	КОНЕЦ КАК ПервоначальнаяСтоимостьВРКонечныйОстаток
	|ИЗ
	|	ТаблицаМатериалы КАК ТаблицаМатериалы
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаПогашениеСтоимостиМатериалов КАК ТаблицаПогашениеСтоимостиМатериалов
	|		ПО ТаблицаМатериалы.СчетПередачи = ТаблицаПогашениеСтоимостиМатериалов.СчетПередачи
	|			И ТаблицаМатериалы.СчетМЦ = ТаблицаПогашениеСтоимостиМатериалов.СчетМЦ
	|			И ТаблицаМатериалы.Номенклатура = ТаблицаПогашениеСтоимостиМатериалов.Номенклатура
	|			И ТаблицаМатериалы.ПартияМатериаловВЭксплуатации = ТаблицаПогашениеСтоимостиМатериалов.ПартияМатериаловВЭксплуатации
	|			И ТаблицаМатериалы.ФизЛицо = ТаблицаПогашениеСтоимостиМатериалов.ФизЛицо
	|			И (ТаблицаМатериалы.Подразделение = ТаблицаПогашениеСтоимостиМатериалов.Подразделение ИЛИ ТаблицаПогашениеСтоимостиМатериалов.Подразделение ЕСТЬ NULL)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный.Остатки(
	|				&Период,
	|				Счет В (&СчетаУчетаСпецодеждыЗабалансовый),
	|				&ВидыСубконтоСпецодежда,
	|				Организация = &Организация
	|					И (Подразделение = &Подразделение
	|						ИЛИ Подразделение ЕСТЬ NULL )) КАК ХозрасчетныйОстаткиСпецодежда
	|		ПО ТаблицаМатериалы.СчетМЦ = ХозрасчетныйОстаткиСпецодежда.Счет
	|			И ТаблицаМатериалы.Номенклатура = ХозрасчетныйОстаткиСпецодежда.Субконто1
	|			И ТаблицаМатериалы.ПартияМатериаловВЭксплуатации = ХозрасчетныйОстаткиСпецодежда.Субконто2
	|			И ТаблицаМатериалы.ФизЛицо = ХозрасчетныйОстаткиСпецодежда.Субконто3
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный.Остатки(
	|				&Период,
	|				Счет В (&СчетаУчетаСпецоснасткиЗабалансовый),
	|				&ВидыСубконтоСпецоснастка,
	|				Организация = &Организация
	|					И (Подразделение = &Подразделение
	|						ИЛИ Подразделение ЕСТЬ NULL )) КАК ХозрасчетныйОстаткиСпецоснастка
	|		ПО ТаблицаМатериалы.СчетМЦ = ХозрасчетныйОстаткиСпецоснастка.Счет
	|			И ТаблицаМатериалы.Номенклатура = ХозрасчетныйОстаткиСпецоснастка.Субконто1
	|			И ТаблицаМатериалы.ПартияМатериаловВЭксплуатации = ХозрасчетныйОстаткиСпецоснастка.Субконто2
	|
	|УПОРЯДОЧИТЬ ПО
	|	ИмяСписка,
	|	НомерСтроки";
	Запрос.УстановитьПараметр("ТаблицаМатериалы", 						ТаблицаМатериалы);
	Запрос.УстановитьПараметр("ТаблицаПогашениеСтоимостиМатериалов", 	ТаблицаПогашениеСтоимостиМатериалов);
	Запрос.УстановитьПараметр("Период", Новый Граница(Новый МоментВремени(Реквизиты.Период, Реквизиты.Регистратор), ВидГраницы.Исключая));
	Запрос.УстановитьПараметр("Организация", 							Реквизиты.Организация);
	Запрос.УстановитьПараметр("Подразделение", 							Реквизиты.Подразделение);
	Запрос.УстановитьПараметр("СчетаУчетаСпецодеждыЗабалансовый",   		
		БухгалтерскийУчетПовтИсп.СчетаВИерархии(ПланыСчетов.Хозрасчетный.СпецодеждаВЭксплуатацииВспомогательный));
	Запрос.УстановитьПараметр("СчетаУчетаСпецоснасткиЗабалансовый", 		
		БухгалтерскийУчетПовтИсп.СчетаВИерархии(ПланыСчетов.Хозрасчетный.СпецоснасткаВЭксплуатацииВспомогательный));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", 		Константы.ВалютаРегламентированногоУчета.Получить());
	Запрос.УстановитьПараметр("ПустоеПодразделение", 					БухгалтерскийУчетПереопределяемый.ПустоеПодразделение());
	
	ВидыСубконтоСпецодежда = Новый Массив;
	ВидыСубконтоСпецодежда.Добавить(ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.Номенклатура);
	ВидыСубконтоСпецодежда.Добавить(ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.ПартииМатериаловВЭксплуатации);
	ВидыСубконтоСпецодежда.Добавить(ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.РаботникиОрганизаций);
	
	ВидыСубконтоСпецоснастка = Новый Массив;
	ВидыСубконтоСпецоснастка.Добавить(ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.Номенклатура);
	ВидыСубконтоСпецоснастка.Добавить(ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.ПартииМатериаловВЭксплуатации);
	
	Запрос.УстановитьПараметр("ВидыСубконтоСпецодежда",   ВидыСубконтоСпецодежда);
	Запрос.УстановитьПараметр("ВидыСубконтоСпецоснастка", ВидыСубконтоСпецоснастка);
	
	ТаблицаСписанныеМатериалы = Запрос.Выполнить().Выгрузить();
	
	ТаблицаСписанныеМатериалы.Колонки.Добавить("Сумма",   ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	ТаблицаСписанныеМатериалы.Колонки.Добавить("СуммаНУ", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	ТаблицаСписанныеМатериалы.Колонки.Добавить("СуммаПР", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	ТаблицаСписанныеМатериалы.Колонки.Добавить("СуммаВР", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	
	ТаблицаСписанныеМатериалы.Колонки.Добавить("СуммаМЦ",   ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	ТаблицаСписанныеМатериалы.Колонки.Добавить("СуммаМЦНУ", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	ТаблицаСписанныеМатериалы.Колонки.Добавить("СуммаМЦПР", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	ТаблицаСписанныеМатериалы.Колонки.Добавить("СуммаМЦВР", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	
	Для Каждого СтрокаТаблицы Из ТаблицаСписанныеМатериалы Цикл
		
		// Проверяем, достаточный ли остаток по количеству (на забалансовом счете МЦ)
		Если СтрокаТаблицы.КоличествоМЦ > СтрокаТаблицы.КоличествоМЦОстаток Тогда
		
			ТекстОшибки = НСтр("ru='Указанное количество превышает остаток по счету %1.
				|Остаток: %2; Не хватает: %3'");
			ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстОшибки,
				СтрокаТаблицы.СчетМЦ,
				СтрокаТаблицы.КоличествоМЦОстаток,
				СтрокаТаблицы.КоличествоМЦ - СтрокаТаблицы.КоличествоМЦОстаток);
			ТекстСообщения = ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Колонка", "Корректность",
				НСтр("ru = 'Количество'"),
				СтрокаТаблицы.НомерСтроки,
				СтрокаТаблицы.СинонимСписка,
				ТекстОшибки);
			Поле = СтрокаТаблицы.ИмяСписка + "[" + Формат(СтрокаТаблицы.НомерСтроки - 1, "ЧН=0; ЧГ=") + "].Количество";

			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, Реквизиты.Регистратор, Поле, "Объект", Отказ);
		
			Продолжить;
			
		КонецЕсли;
		
		// Рассчитываем суммы списания
		ДоляСписанияМЦ = ?(СтрокаТаблицы.КоличествоМЦОстаток = 0, 0, СтрокаТаблицы.КоличествоМЦ / СтрокаТаблицы.КоличествоМЦОстаток);
		СтрокаТаблицы.СуммаМЦ   = СтрокаТаблицы.ПервоначальнаяСтоимостьКонечныйОстаток * ДоляСписанияМЦ;
		СтрокаТаблицы.СуммаМЦНУ = СтрокаТаблицы.ПервоначальнаяСтоимостьНУКонечныйОстаток * ДоляСписанияМЦ;
		СтрокаТаблицы.СуммаМЦПР = СтрокаТаблицы.ПервоначальнаяСтоимостьПРКонечныйОстаток * ДоляСписанияМЦ;
		СтрокаТаблицы.СуммаМЦВР = СтрокаТаблицы.ПервоначальнаяСтоимостьВРКонечныйОстаток * ДоляСписанияМЦ;
		
		Если (ВидОперацииСписания = "Возврат")
		 ИЛИ (ВидОперацииСписания = "Списание"
		  И (СтрокаТаблицы.СпособПогашенияСтоимости = Перечисления.СпособыПогашенияСтоимости.Линейный
		 ИЛИ СтрокаТаблицы.СпособПогашенияСтоимости = Перечисления.СпособыПогашенияСтоимости.ПропорциональноОбъемуПродукцииРабот))
		Тогда
		
			// Проверяем, достаточный ли остаток по количеству (на счете бух. учета)
			Если СтрокаТаблицы.Количество > СтрокаТаблицы.КоличествоОстаток Тогда
			
				ТекстОшибки = НСтр("ru='Указанное количество превышает остаток по счету %1.
					|Остаток: %2; Не хватает: %3'");
				ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстОшибки,
					СтрокаТаблицы.СчетПередачи,
					СтрокаТаблицы.КоличествоОстаток,
					СтрокаТаблицы.Количество - СтрокаТаблицы.КоличествоОстаток);
				ТекстСообщения = ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Колонка", "Корректность",
					НСтр("ru = 'Количество'"),
					СтрокаТаблицы.НомерСтроки,
					СтрокаТаблицы.СинонимСписка,
					ТекстОшибки);
				Поле = СтрокаТаблицы.ИмяСписка + "[" + Формат(СтрокаТаблицы.НомерСтроки - 1, "ЧН=0; ЧГ=") + "].Количество";

				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, Реквизиты.Регистратор, Поле, "Объект", Отказ);
			
				Продолжить;
				
			КонецЕсли;
			
			// Рассчитываем суммы списания
			ДоляСписания = ?(СтрокаТаблицы.КоличествоОстаток = 0, 0, СтрокаТаблицы.Количество / СтрокаТаблицы.КоличествоОстаток);
			СтрокаТаблицы.Сумма   = СтрокаТаблицы.СтоимостьКонечныйОстаток * ДоляСписания - СтрокаТаблицы.СуммаПогашения;
			СтрокаТаблицы.СуммаНУ = СтрокаТаблицы.СтоимостьНУКонечныйОстаток * ДоляСписания - СтрокаТаблицы.СуммаПогашенияНУ;
			СтрокаТаблицы.СуммаПР = СтрокаТаблицы.СтоимостьПРКонечныйОстаток * ДоляСписания - СтрокаТаблицы.СуммаПогашенияПР;
			СтрокаТаблицы.СуммаВР = СтрокаТаблицы.СтоимостьВРКонечныйОстаток * ДоляСписания - СтрокаТаблицы.СуммаПогашенияВР;
			
		ИначеЕсли ВидОперацииСписания = "Списание" Тогда
			// Материалы, списанные на затраты при передаче в эксплуатацию,
			// необходимо списать только с забалансового счета учета (МЦ)
			СтрокаТаблицы.Количество = 0;

		КонецЕсли;
		
	КонецЦикла;

	Возврат ТаблицаСписанныеМатериалы;

КонецФункции

Функция ПодготовитьТаблицуСписанныеПоНазначениюИспользованияСпецодеждаСпецоснастка(ТаблицаСписанныеМатериалы, Реквизиты, Отказ)
	
	СписокКолонок = ""
	+ "СчетПередачи,"
	+ "Номенклатура,"
	+ "ПартияМатериаловВЭксплуатации,"
	+ "ФизЛицо,"
	+ "Подразделение,"
	+ "СпособОтраженияРасходов,"
	+ "Количество,"
	+ "Сумма,"
	+ "СуммаНУ,"
	+ "СуммаПР,"
	+ "СуммаВР,"
	+ "Содержание";
	
	ТаблицаСписаниеМатериалов = ТаблицаСписанныеМатериалы.Скопировать(, СписокКолонок);
	ТаблицаСписаниеМатериалов.Колонки.Добавить("КоличествоМЦ", ОбщегоНазначения.ОписаниеТипаЧисло(15,3));
	
	// Материалы необходимо списать на затраты так, как указано в способе отражения расходов
	ТаблицаСписанныеПоНазначениюИспользованияМатериалы = ПодготовитьТаблицуНачислениеПогашенияСтоимостиСпецодеждыСпецоснастки(
		ТаблицаСписаниеМатериалов, Реквизиты, Отказ);
	
	Возврат ТаблицаСписанныеПоНазначениюИспользованияМатериалы;
	
КонецФункции

Функция ПодготовитьТаблицуСписанныйИзЭксплуатацииИнвентарь(ТаблицаМатериалы, Реквизиты, Отказ)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТаблицаМатериалы.ИмяСписка,
	|	ТаблицаМатериалы.СинонимСписка,
	|	ТаблицаМатериалы.НомерСтроки,
	|	ТаблицаМатериалы.СчетМЦ КАК СчетМЦ,
	|	ТаблицаМатериалы.Номенклатура КАК Номенклатура,
	|	ТаблицаМатериалы.ПартияМатериаловВЭксплуатации КАК ПартияМатериаловВЭксплуатации,
	|	ЕСТЬNULL(ТаблицаМатериалы.ФизЛицо, ЗНАЧЕНИЕ(Справочник.ФизическиеЛица.ПустаяСсылка)) КАК ФизЛицо,
	|	ТаблицаМатериалы.КоличествоМЦ,
	|	ТаблицаМатериалы.Содержание
	|ПОМЕСТИТЬ ТаблицаМатериалы
	|ИЗ
	|	&ТаблицаМатериалы КАК ТаблицаМатериалы
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СчетМЦ,
	|	Номенклатура,
	|	ПартияМатериаловВЭксплуатации,
	|	ФизЛицо
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаМатериалы.ИмяСписка КАК ИмяСписка,
	|	ТаблицаМатериалы.СинонимСписка,
	|	ТаблицаМатериалы.НомерСтроки КАК НомерСтроки,
	|	ТаблицаМатериалы.СчетМЦ,
	|	ТаблицаМатериалы.Номенклатура,
	|	ТаблицаМатериалы.ПартияМатериаловВЭксплуатации,
	|	ТаблицаМатериалы.ФизЛицо,
	|	&Подразделение КАК Подразделение,
	|	ТаблицаМатериалы.КоличествоМЦ,
	|	ТаблицаМатериалы.Содержание,
	|	ЕСТЬNULL(ХозрасчетныйОстаткиМЦ.КоличествоОстатокДт, 0) КАК КоличествоМЦОстаток,
	|	ЕСТЬNULL(ХозрасчетныйОстаткиМЦ.СуммаОстатокДт, 0) КАК ПервоначальнаяСтоимостьКонечныйОстаток,
	|	ЕСТЬNULL(ХозрасчетныйОстаткиМЦ.СуммаНУОстатокДт, 0) КАК ПервоначальнаяСтоимостьНУКонечныйОстаток,
	|	ЕСТЬNULL(ХозрасчетныйОстаткиМЦ.СуммаПРОстатокДт, 0) КАК ПервоначальнаяСтоимостьПРКонечныйОстаток,
	|	ЕСТЬNULL(ХозрасчетныйОстаткиМЦ.СуммаВРОстатокДт, 0) КАК ПервоначальнаяСтоимостьВРКонечныйОстаток
	|ИЗ
	|	ТаблицаМатериалы КАК ТаблицаМатериалы
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный.Остатки(
	|				&Период,
	|				Счет В (&СчетаУчетаИнвентаряЗабалансовый),
	|				&ВидыСубконтоИнвентарь,
	|				Организация = &Организация
	|					И (Подразделение = &Подразделение
	|						ИЛИ Подразделение ЕСТЬ NULL )) КАК ХозрасчетныйОстаткиМЦ
	|		ПО ТаблицаМатериалы.СчетМЦ = ХозрасчетныйОстаткиМЦ.Счет
	|			И ТаблицаМатериалы.Номенклатура = ХозрасчетныйОстаткиМЦ.Субконто1
	|			И ТаблицаМатериалы.ПартияМатериаловВЭксплуатации = ХозрасчетныйОстаткиМЦ.Субконто2
	|			И ТаблицаМатериалы.ФизЛицо = ХозрасчетныйОстаткиМЦ.Субконто3
	|
	|УПОРЯДОЧИТЬ ПО
	|	ИмяСписка,
	|	НомерСтроки";
	Запрос.УстановитьПараметр("ТаблицаМатериалы", ТаблицаМатериалы);
	Запрос.УстановитьПараметр("Период", Новый Граница(Новый МоментВремени(Реквизиты.Период, Реквизиты.Регистратор), ВидГраницы.Исключая));
	Запрос.УстановитьПараметр("Организация", 	  Реквизиты.Организация);
	Запрос.УстановитьПараметр("Подразделение",	  Реквизиты.Подразделение);
	Запрос.УстановитьПараметр("СчетаУчетаИнвентаряЗабалансовый", 
		БухгалтерскийУчетПовтИсп.СчетаВИерархии(ПланыСчетов.Хозрасчетный.ИнвентарьИХозяйственныеПринадлежностиВЭксплуатации));
	
	ВидыСубконтоИнвентарь = Новый Массив;
	ВидыСубконтоИнвентарь.Добавить(ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.Номенклатура);
	ВидыСубконтоИнвентарь.Добавить(ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.ПартииМатериаловВЭксплуатации);
	ВидыСубконтоИнвентарь.Добавить(ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.РаботникиОрганизаций);
	Запрос.УстановитьПараметр("ВидыСубконтоИнвентарь", ВидыСубконтоИнвентарь);
	
	ТаблицаСписанныеМатериалы = Запрос.Выполнить().Выгрузить();
	
	ТаблицаСписанныеМатериалы.Колонки.Добавить("СуммаМЦ",   ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	ТаблицаСписанныеМатериалы.Колонки.Добавить("СуммаМЦНУ", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	ТаблицаСписанныеМатериалы.Колонки.Добавить("СуммаМЦПР", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	ТаблицаСписанныеМатериалы.Колонки.Добавить("СуммаМЦВР", ОбщегоНазначения.ОписаниеТипаЧисло(15,2));
	
	Для Каждого СтрокаТаблицы Из ТаблицаСписанныеМатериалы Цикл
		
		// Проверяем, достаточный ли остаток по количеству (на забалансовом счете МЦ)
		Если СтрокаТаблицы.КоличествоМЦ > СтрокаТаблицы.КоличествоМЦОстаток Тогда
		
			ТекстОшибки = НСтр("ru='Указанное количество превышает остаток по счету %1.
				|Остаток: %2; Не хватает: %3'");
			ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстОшибки,
				СтрокаТаблицы.СчетМЦ,
				СтрокаТаблицы.КоличествоМЦОстаток,
				СтрокаТаблицы.КоличествоМЦ - СтрокаТаблицы.КоличествоМЦОстаток);
			ТекстСообщения = ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Колонка", "Корректность",
				НСтр("ru = 'Количество'"),
				СтрокаТаблицы.НомерСтроки,
				СтрокаТаблицы.СинонимСписка,
				ТекстОшибки);
			Поле = СтрокаТаблицы.ИмяСписка + "[" + Формат(СтрокаТаблицы.НомерСтроки - 1, "ЧН=0; ЧГ=") + "].Количество";

			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, Реквизиты.Регистратор, Поле, "Объект", Отказ);
		
			Продолжить;
			
		КонецЕсли;
		
		// Рассчитываем суммы списания
		ДоляСписанияМЦ = ?(СтрокаТаблицы.КоличествоМЦОстаток = 0, 0, СтрокаТаблицы.КоличествоМЦ / СтрокаТаблицы.КоличествоМЦОстаток);
		СтрокаТаблицы.СуммаМЦ   = СтрокаТаблицы.ПервоначальнаяСтоимостьКонечныйОстаток * ДоляСписанияМЦ;
		СтрокаТаблицы.СуммаМЦНУ = 0;
		СтрокаТаблицы.СуммаМЦПР = СтрокаТаблицы.ПервоначальнаяСтоимостьПРКонечныйОстаток * ДоляСписанияМЦ;
		СтрокаТаблицы.СуммаМЦВР = СтрокаТаблицы.ПервоначальнаяСтоимостьВРКонечныйОстаток * ДоляСписанияМЦ;
		
	КонецЦикла;

	Возврат ТаблицаСписанныеМатериалы;

КонецФункции

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ, ВЫПОЛНЯЮЩИЕ ДВИЖЕНИЯ ПО РЕГИСТРАМ

// ДВИЖЕНИЯ РЕГИСТРА БУХГАЛТЕРИИ

Процедура СформироватьПроводкиПогашениеСтоимостиСпецодеждыСпецоснастки(ТаблицаПогашенияСтоимости, Реквизиты, Движения, Отказ) Экспорт
	
	ОтражатьВНалоговомУчете = УчетнаяПолитика.ПлательщикНалогаНаПрибыль(Реквизиты.Организация, Реквизиты.Период);
	ПоддержкаПБУ18 = УчетнаяПолитика.ПоддержкаПБУ18(Реквизиты.Организация, Реквизиты.Период);
	
	// С целью оптимизации производительности напрямую (а не через функции с повторно используемыми значениями) кешируем
	// свойства счетов. При заполнении субконто исключаем лишние проверки на значения субконто (наличие субконто на счете
	// и т.п. существующие в алгоритме как предусловия).
	СвойстваСчетовДтКеш = Новый Соответствие;
	СчетКтПредыдущий = ПланыСчетов.Хозрасчетный.ПустаяСсылка();
	
	// С целью оптимизации производительности предопределенные значения помещаются в переменные.
	ВидСубконтоНоменклатура                  = ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.Номенклатура;
	ВидСубконтоПартииМатериаловВЭксплуатации = ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.ПартииМатериаловВЭксплуатации;
	ВидСубконтоРаботникиОрганизаций          = ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.РаботникиОрганизаций;
	
	Для каждого СтрокаТаблицы из ТаблицаПогашенияСтоимости Цикл

		Если СтрокаТаблицы.Количество = 0
		   И СтрокаТаблицы.Сумма = 0
		   И СтрокаТаблицы.СуммаНУ = 0
		   И СтрокаТаблицы.СуммаПР = 0
		   И СтрокаТаблицы.СуммаВР = 0
		Тогда
			Продолжить;
		КонецЕсли;
		
		СуммаНУДт = 0;
		СуммаПРДт = 0;
		СуммаВРДт = 0;
		СуммаНУКт = 0;
		СуммаПРКт = 0;
		СуммаВРКт = 0;
		
		Проводка = Движения.Хозрасчетный.Добавить();
		// Здесь заполнение субконто счета Дт, для производительности совмещенное с получением свойсв счета.
		// Заполнение самого счета и подразделения будет далее после проверок на ненулевые суммы.
		СвойстваСчетаДт = БухгалтерскийУчет.УстановитьСубконтоПоКешуСвойствСчета(СтрокаТаблицы.СчетРасходов, Проводка.СубконтоДт, СвойстваСчетовДтКеш,
				СтрокаТаблицы.СубконтоРасходов1, СтрокаТаблицы.СубконтоРасходов2, СтрокаТаблицы.СубконтоРасходов3);
				
		Если СтрокаТаблицы.СчетПередачи <> СчетКтПредыдущий Тогда   // первое использование счета передачи	
			
			// Предполагаем, что счетов передачи лишь несколько, и в ТаблицаПогашенияСтоимости спецодежда по одному счету идет подряд.
			// Поэтому ограничиваемся запоминанием только предыдущего счета, а не всех использованных счетов.
			
			СчетКтПредыдущий = СтрокаТаблицы.СчетПередачи;
			СвойстваСчетаКт = БухгалтерскийУчетВызовСервераПовтИсп.ПолучитьСвойстваСчета(СтрокаТаблицы.СчетПередачи);
			ИспользуемыеВидыСубконтоСчетКт = Новый Структура;
			ИспользуемыеВидыСубконтоСчетКт.Вставить("Номенклатура", СвойстваСчетаКт.ВидСубконто1 = ВидСубконтоНоменклатура
																		Или СвойстваСчетаКт.ВидСубконто2 = ВидСубконтоНоменклатура
																		Или СвойстваСчетаКт.ВидСубконто3 = ВидСубконтоНоменклатура);
			ИспользуемыеВидыСубконтоСчетКт.Вставить("ПартииМатериаловВЭксплуатации", СвойстваСчетаКт.ВидСубконто2 = ВидСубконтоПартииМатериаловВЭксплуатации 
																		Или СвойстваСчетаКт.ВидСубконто1 = ВидСубконтоПартииМатериаловВЭксплуатации
																		Или СвойстваСчетаКт.ВидСубконто3 = ВидСубконтоПартииМатериаловВЭксплуатации);
			ИспользуемыеВидыСубконтоСчетКт.Вставить("РаботникиОрганизаций", СвойстваСчетаКт.ВидСубконто3 = ВидСубконтоРаботникиОрганизаций
																		Или СвойстваСчетаКт.ВидСубконто2 = ВидСубконтоРаботникиОрганизаций
																		Или СвойстваСчетаКт.ВидСубконто1 = ВидСубконтоРаботникиОрганизаций);
		КонецЕсли;
		
		Если ОтражатьВНалоговомУчете Тогда
			
			ЭтоНеПринимаемыйРасходНУ = НалоговыйУчет.ЭтоНепринимаемыйРасходНУ(СтрокаТаблицы.СубконтоРасходов1,
				СтрокаТаблицы.СубконтоРасходов2, СтрокаТаблицы.СубконтоРасходов3);
				
			Если СвойстваСчетаДт.НалоговыйУчет Тогда
				
				СуммаНУДт = ?(ЭтоНеПринимаемыйРасходНУ, 0, СтрокаТаблицы.СуммаНУ);
				
				Если ПоддержкаПБУ18 Тогда
					Если СтрокаТаблицы.Сумма = 0 Тогда
						СуммаПРДт = 0;
		    			СуммаВРДт = ?(ЭтоНеПринимаемыйРасходНУ, 0, - СтрокаТаблицы.СуммаНУ);
					Иначе
						СуммаПРДт = ?(ЭтоНеПринимаемыйРасходНУ, СтрокаТаблицы.СуммаНУ + СтрокаТаблицы.СуммаПР, СтрокаТаблицы.СуммаПР);
		    			СуммаВРДт = СтрокаТаблицы.СуммаВР;
					КонецЕсли;
				КонецЕсли;
				
			КонецЕсли;
			
			Если СвойстваСчетаКт.НалоговыйУчет Тогда
				
				СуммаНУКт = СтрокаТаблицы.СуммаНУ;
				
				Если ПоддержкаПБУ18 Тогда
					Если СтрокаТаблицы.Сумма = 0 Тогда
						СуммаПРКт = ?(ЭтоНеПринимаемыйРасходНУ, - СтрокаТаблицы.СуммаНУ, 0);
						СуммаВРКт = ?(ЭтоНеПринимаемыйРасходНУ, 0, - СтрокаТаблицы.СуммаНУ);
					Иначе
						СуммаПРКт = СтрокаТаблицы.СуммаПР;
						СуммаВРКт = СтрокаТаблицы.СуммаВР;
					КонецЕсли;
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
		Если СтрокаТаблицы.Количество = 0
		   И СтрокаТаблицы.Сумма = 0
		   И СуммаНУДт = 0
		   И СуммаПРДт = 0
		   И СуммаВРДт = 0
		   И СуммаНУКт = 0
		   И СуммаПРКт = 0
		   И СуммаВРКт = 0
		Тогда
		    Движения.Хозрасчетный.Удалить(Проводка);
			Продолжить;
		КонецЕсли;
		
		Проводка.Период      = Реквизиты.Период;
		Проводка.Организация = Реквизиты.Организация;
		Проводка.Содержание  = "Погашение стоимости " + БухгалтерскийУчетПовтИсп.НазваниеОбъектаПоСчетуУчета(СтрокаТаблицы.СчетПередачи);
		
		Проводка.СчетДт = СтрокаТаблицы.СчетРасходов;
		// Субконто Дт были заполнены выше при получении СвойстваСчетаДт.
		Если СвойстваСчетаДт.УчетПоПодразделениям Тогда
			Проводка.ПодразделениеДт = СтрокаТаблицы.ПодразделениеРасходов;
		КонецЕсли;
		Если СвойстваСчетаДт.Количественный Тогда
			Проводка.КоличествоДт = СтрокаТаблицы.Количество;
		КонецЕсли;
		
		Проводка.СчетКт = СтрокаТаблицы.СчетПередачи;
		Если ИспользуемыеВидыСубконтоСчетКт.Номенклатура Тогда
			Проводка.СубконтоКт.Вставить(ВидСубконтоНоменклатура,                  СтрокаТаблицы.Номенклатура);
		КонецЕсли;
		Если ИспользуемыеВидыСубконтоСчетКт.ПартииМатериаловВЭксплуатации Тогда
			Проводка.СубконтоКт.Вставить(ВидСубконтоПартииМатериаловВЭксплуатации, СтрокаТаблицы.ПартияМатериаловВЭксплуатации);
		КонецЕсли;
		Если ИспользуемыеВидыСубконтоСчетКт.РаботникиОрганизаций Тогда
			Проводка.СубконтоКт.Вставить(ВидСубконтоРаботникиОрганизаций,          СтрокаТаблицы.ФизЛицо);
		КонецЕсли;
		Если СвойстваСчетаКт.УчетПоПодразделениям Тогда
			Проводка.ПодразделениеКт = СтрокаТаблицы.Подразделение;
		КонецЕсли;
		Если СвойстваСчетаКт.Количественный Тогда
			Проводка.КоличествоКт = СтрокаТаблицы.Количество;
		КонецЕсли;
		
		Проводка.Сумма = СтрокаТаблицы.Сумма;

		Если ОтражатьВНалоговомУчете Тогда
			
			Если СвойстваСчетаДт.НалоговыйУчет Тогда
				
				Проводка.СуммаНУДт = СуммаНУДт;
				
				Если ПоддержкаПБУ18 Тогда
					Проводка.СуммаПРДт = СуммаПРДт;
		    		Проводка.СуммаВРДт = СуммаВРДт;
				КонецЕсли;
				
			КонецЕсли;
			
			Если СвойстваСчетаКт.НалоговыйУчет Тогда
				
				Проводка.СуммаНУКт = СуммаНУКт;
				
				Если ПоддержкаПБУ18 Тогда
					Проводка.СуммаПРКт = СуммаПРКт;
					Проводка.СуммаВРКт = СуммаВРКт;
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Движения.Хозрасчетный.Записывать = Истина;
	
КонецПроцедуры

Процедура СформироватьПроводкиПоступлениеСпецодеждыСпецоснасткиВЭксплуатациюМЦ(ТаблицаПогашенияСтоимости, Реквизиты, Движения, Отказ) Экспорт
	
	ОтражатьВНалоговомУчете = УчетнаяПолитика.ПлательщикНалогаНаПрибыль(Реквизиты.Организация, Реквизиты.Период);
	ПоддержкаПБУ18 = УчетнаяПолитика.ПоддержкаПБУ18(Реквизиты.Организация, Реквизиты.Период);
	
	Для каждого СтрокаТаблицы из ТаблицаПогашенияСтоимости Цикл

		Если СтрокаТаблицы.СуммаМЦ = 0
		   И СтрокаТаблицы.СуммаМЦНУ = 0
		   И СтрокаТаблицы.СуммаПР = 0
		   И СтрокаТаблицы.СуммаВР = 0
		   И СтрокаТаблицы.КоличествоМЦ = 0
		Тогда
			Продолжить;
		КонецЕсли;
	
		Проводка = Движения.Хозрасчетный.Добавить();
		Проводка.Период      = Реквизиты.Период;
		Проводка.Организация = Реквизиты.Организация;
		Проводка.Содержание  = "Передача " + БухгалтерскийУчетПовтИсп.НазваниеОбъектаПоСчетуУчета(СтрокаТаблицы.СчетПередачи) + " в эксплуатацию";
		
		Проводка.СчетДт = СтрокаТаблицы.СчетМЦ;
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт, Проводка.СубконтоДт, "Номенклатура", СтрокаТаблицы.Номенклатура);
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт, Проводка.СубконтоДт, "ПартииМатериаловВЭксплуатации", СтрокаТаблицы.ПартияМатериаловВЭксплуатации);
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт, Проводка.СубконтоДт, "РаботникиОрганизаций", СтрокаТаблицы.ФизЛицо);
		
		СвойстваСчетаДт = БухгалтерскийУчетВызовСервераПовтИсп.ПолучитьСвойстваСчета(Проводка.СчетДт);
		
		Если СвойстваСчетаДт.УчетПоПодразделениям Тогда
			Проводка.ПодразделениеДт = СтрокаТаблицы.Подразделение;
		КонецЕсли;
		
		Если СвойстваСчетаДт.Количественный Тогда
			Проводка.КоличествоДт = СтрокаТаблицы.КоличествоМЦ;
		КонецЕсли;
		
		Проводка.Сумма = СтрокаТаблицы.СуммаМЦ;
		
		Если ОтражатьВНалоговомУчете Тогда
			
			ЭтоНеПринимаемыйРасходНУ = НалоговыйУчет.ЭтоНепринимаемыйРасходНУ(СтрокаТаблицы.СубконтоРасходов1,
				СтрокаТаблицы.СубконтоРасходов2, СтрокаТаблицы.СубконтоРасходов3);
				
			Если СтрокаТаблицы.СпособПогашенияСтоимостиНУ = Перечисления.СпособыПогашенияСтоимости.ПогашатьСтоимостьПриПередачеВЭксплуатацию Тогда	
				
				Если СвойстваСчетаДт.НалоговыйУчет Тогда
					
					Проводка.СуммаНУДт = 0;
					
					Если ПоддержкаПБУ18 Тогда
						Если СтрокаТаблицы.Сумма = 0 Тогда
							Проводка.СуммаПРДт = ?(ЭтоНеПринимаемыйРасходНУ, СтрокаТаблицы.СуммаМЦНУ + СтрокаТаблицы.СуммаПР, СтрокаТаблицы.СуммаПР);
							Проводка.СуммаВРДт = ?(ЭтоНеПринимаемыйРасходНУ, СтрокаТаблицы.СуммаВР, СтрокаТаблицы.СуммаМЦНУ + СтрокаТаблицы.СуммаВР);
						Иначе
							Проводка.СуммаПРДт = 0;
							Проводка.СуммаВРДт = 0;
						КонецЕсли;
					КонецЕсли;
					
				КонецЕсли;
				
			Иначе
							
				Если СвойстваСчетаДт.НалоговыйУчет Тогда
					
					Проводка.СуммаНУДт = СтрокаТаблицы.СуммаМЦНУ;
					
					Если ПоддержкаПБУ18 Тогда
						Если СтрокаТаблицы.Сумма = 0 Тогда
							Проводка.СуммаПРДт = СтрокаТаблицы.СуммаПР;
							Проводка.СуммаВРДт = СтрокаТаблицы.СуммаВР;
						Иначе
							Проводка.СуммаПРДт = 0;
							Проводка.СуммаВРДт = 0;
						КонецЕсли;
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Движения.Хозрасчетный.Записывать = Истина;
	
КонецПроцедуры

Процедура СформироватьПроводкиПоступлениеИнвентаряВЭксплуатациюМЦ(ТаблицаМатериалы, Реквизиты, Движения, Отказ)
	
	Для каждого СтрокаТаблицы из ТаблицаМатериалы Цикл

		Если СтрокаТаблицы.Сумма = 0
		   И СтрокаТаблицы.КоличествоМЦ = 0
		Тогда
			Продолжить;
		КонецЕсли;
	
		Проводка = Движения.Хозрасчетный.Добавить();
		Проводка.Период      = Реквизиты.Период;
		Проводка.Организация = Реквизиты.Организация;
		
		Если СтрокаТаблицы.ИмяСписка = "Спецодежда" Тогда
			Проводка.Содержание  = "Передача спецодежды в эксплуатацию";
		ИначеЕсли СтрокаТаблицы.ИмяСписка = "Спецоснастка" Тогда
			Проводка.Содержание  = "Передача спецоснастки в эксплуатацию";
		Иначе
			Проводка.Содержание  = "Передача инвентаря в эксплуатацию";
		КонецЕсли;
		
		Проводка.СчетДт = СтрокаТаблицы.СчетМЦ;
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт, Проводка.СубконтоДт, "Номенклатура", СтрокаТаблицы.Номенклатура);
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт, Проводка.СубконтоДт, "ПартииМатериаловВЭксплуатации", СтрокаТаблицы.ПартияМатериаловВЭксплуатации);
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт, Проводка.СубконтоДт, "РаботникиОрганизаций", СтрокаТаблицы.ФизЛицо);
		
		СвойстваСчетаДт = БухгалтерскийУчетВызовСервераПовтИсп.ПолучитьСвойстваСчета(Проводка.СчетДт);
		
		Если СвойстваСчетаДт.УчетПоПодразделениям Тогда
			Проводка.ПодразделениеДт = СтрокаТаблицы.Подразделение;
		КонецЕсли;
		
		Если СвойстваСчетаДт.Количественный Тогда
			Проводка.КоличествоДт = СтрокаТаблицы.КоличествоМЦ;
		КонецЕсли;
		
		Проводка.Сумма = СтрокаТаблицы.Сумма;
		
	КонецЦикла;
	
	Движения.Хозрасчетный.Записывать = Истина;
	
КонецПроцедуры

Процедура СформироватьПроводкиСписаниеМатериаловИзЭксплуатации(ТаблицаСписанныеМатериалы, Реквизиты, Движения, Отказ)
	
	СпособОценкиМПЗ = УчетнаяПолитика.СпособОценкиМПЗ(Реквизиты.Организация, Реквизиты.Период);
	ВедетсяУчетПоПартиям = СпособОценкиМПЗ <> Перечисления.СпособыОценки.ПоСредней;
	ОтражатьВНалоговомУчете = УчетнаяПолитика.ПлательщикНалогаНаПрибыль(Реквизиты.Организация, Реквизиты.Период);
	ПоддержкаПБУ18 = УчетнаяПолитика.ПоддержкаПБУ18(Реквизиты.Организация, Реквизиты.Период);
	
	ЕстьКолонкиВидСубконто = ТаблицаСписанныеМатериалы.Колонки.Найти("ВидСубконтоРасходов1") <> Неопределено
							И ТаблицаСписанныеМатериалы.Колонки.Найти("ВидСубконтоРасходов2") <> Неопределено
							И ТаблицаСписанныеМатериалы.Колонки.Найти("ВидСубконтоРасходов3") <> Неопределено;
	
	Для каждого СтрокаТаблицы из ТаблицаСписанныеМатериалы Цикл

		Если СтрокаТаблицы.Сумма = 0
		   И СтрокаТаблицы.СуммаНУ = 0
		   И СтрокаТаблицы.СуммаПР = 0
		   И СтрокаТаблицы.СуммаВР = 0
		   И СтрокаТаблицы.Количество = 0
		Тогда
			Продолжить;
		КонецЕсли;
	
		Проводка = Движения.Хозрасчетный.Добавить();
		Проводка.Период      = Реквизиты.Период;
		Проводка.Организация = Реквизиты.Организация;
		Проводка.Содержание  = СтрокаТаблицы.Содержание;
		
		Проводка.СчетДт = СтрокаТаблицы.СчетРасходов;
		Для НомерСубконто = 1 По 3 Цикл
			ВидСубконто = ?(ЕстьКолонкиВидСубконто, СтрокаТаблицы["ВидСубконтоРасходов" + НомерСубконто], НомерСубконто);
			БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт, Проводка.СубконтоДт, ВидСубконто, СтрокаТаблицы["СубконтоРасходов" + НомерСубконто]);
		КонецЦикла;
		Если ВедетсяУчетПоПартиям Тогда
			БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт, Проводка.СубконтоДт, "Партии", Реквизиты.Регистратор);
		КонецЕсли;
		
		СвойстваСчетаДт = БухгалтерскийУчетВызовСервераПовтИсп.ПолучитьСвойстваСчета(Проводка.СчетДт);

		Если СвойстваСчетаДт.УчетПоПодразделениям Тогда
			Проводка.ПодразделениеДт = СтрокаТаблицы.ПодразделениеРасходов;
		КонецЕсли;

		Если СвойстваСчетаДт.Количественный Тогда
			Проводка.КоличествоДт = СтрокаТаблицы.Количество;
		КонецЕсли;

		Проводка.СчетКт = СтрокаТаблицы.СчетПередачи;
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетКт, Проводка.СубконтоКт, "Номенклатура", СтрокаТаблицы.Номенклатура);
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетКт, Проводка.СубконтоКт, "ПартииМатериаловВЭксплуатации", СтрокаТаблицы.ПартияМатериаловВЭксплуатации);
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетКт, Проводка.СубконтоКт, "РаботникиОрганизаций", СтрокаТаблицы.ФизЛицо);
		
		СвойстваСчетаКт = БухгалтерскийУчетВызовСервераПовтИсп.ПолучитьСвойстваСчета(Проводка.СчетКт);
		
		Если СвойстваСчетаКт.УчетПоПодразделениям Тогда
			Проводка.ПодразделениеКт = СтрокаТаблицы.Подразделение;
		КонецЕсли;
		
		Если СвойстваСчетаКт.Количественный Тогда
			Проводка.КоличествоКт = СтрокаТаблицы.Количество;
		КонецЕсли;

		Проводка.Сумма = СтрокаТаблицы.Сумма;

		Если ОтражатьВНалоговомУчете Тогда

			Если СвойстваСчетаДт.НалоговыйУчет Тогда
				Проводка.СуммаНУДт = СтрокаТаблицы.СуммаНУ;
				Если ПоддержкаПБУ18 Тогда
					Проводка.СуммаПРДт = СтрокаТаблицы.СуммаПР;
					Проводка.СуммаВРДт = СтрокаТаблицы.СуммаВР;
				КонецЕсли;
			КонецЕсли;

			Если СвойстваСчетаКт.НалоговыйУчет Тогда
				Проводка.СуммаНУКт = СтрокаТаблицы.СуммаНУ;
				Если ПоддержкаПБУ18 Тогда
					Проводка.СуммаПРКт = СтрокаТаблицы.СуммаПР;
					Проводка.СуммаВРКт = СтрокаТаблицы.СуммаВР;
				КонецЕсли;
			КонецЕсли;

		КонецЕсли;

	КонецЦикла;
	
	Движения.Хозрасчетный.Записывать = Истина;
	
КонецПроцедуры

Процедура СформироватьПроводкиСписаниеМатериаловИзЭксплуатацииМЦ(ТаблицаСписанныеМатериалы, Реквизиты, Движения, Отказ)
	
	ОтражатьВНалоговомУчете = УчетнаяПолитика.ПлательщикНалогаНаПрибыль(Реквизиты.Организация, Реквизиты.Период);
	ПоддержкаПБУ18 = УчетнаяПолитика.ПоддержкаПБУ18(Реквизиты.Организация, Реквизиты.Период);
	
	Для каждого СтрокаТаблицы из ТаблицаСписанныеМатериалы Цикл

		Если СтрокаТаблицы.СуммаМЦ = 0
		   И СтрокаТаблицы.СуммаМЦНУ = 0
		   И СтрокаТаблицы.СуммаМЦПР = 0
		   И СтрокаТаблицы.СуммаМЦВР = 0
		   И СтрокаТаблицы.КоличествоМЦ = 0
		Тогда
			Продолжить;
		КонецЕсли;
	
		Проводка = Движения.Хозрасчетный.Добавить();
		Проводка.Период      = Реквизиты.Период;
		Проводка.Организация = Реквизиты.Организация;
		Проводка.Содержание  = СтрокаТаблицы.Содержание;

		Проводка.СчетКт = СтрокаТаблицы.СчетМЦ;
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетКт, Проводка.СубконтоКт, "Номенклатура", СтрокаТаблицы.Номенклатура);
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетКт, Проводка.СубконтоКт, "ПартииМатериаловВЭксплуатации", СтрокаТаблицы.ПартияМатериаловВЭксплуатации);
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетКт, Проводка.СубконтоКт, "РаботникиОрганизаций", СтрокаТаблицы.ФизЛицо);
		
		СвойстваСчетаКт = БухгалтерскийУчетВызовСервераПовтИсп.ПолучитьСвойстваСчета(Проводка.СчетКт);
		
		Если СвойстваСчетаКт.УчетПоПодразделениям Тогда
			Проводка.ПодразделениеКт = СтрокаТаблицы.Подразделение;
		КонецЕсли;
		
		Если СвойстваСчетаКт.Количественный Тогда
			Проводка.КоличествоКт = СтрокаТаблицы.КоличествоМЦ;
		КонецЕсли;

		Проводка.Сумма = СтрокаТаблицы.СуммаМЦ;

		Если ОтражатьВНалоговомУчете Тогда

			Если СвойстваСчетаКт.НалоговыйУчет Тогда
				Проводка.СуммаНУКт = СтрокаТаблицы.СуммаМЦНУ;
				Если ПоддержкаПБУ18 Тогда
					Проводка.СуммаПРКт = СтрокаТаблицы.СуммаМЦПР;
					Проводка.СуммаВРКт = СтрокаТаблицы.СуммаМЦВР;
				КонецЕсли;
			КонецЕсли;

		КонецЕсли;

	КонецЦикла;
	
	Движения.Хозрасчетный.Записывать = Истина;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ ЗАПОЛНЕНИЯ ТАБЛИЧНЫХ ЧАСТЕЙ

// Процедура формирует таблицу остатков спецодежды в незавершенном производстве.
//
Процедура ЗаполнитьСпецодеждуПоОстаткамВЭксплуатации(ДокОбъект, ТаблицаМатериалы, ВключатьЗабалансовые = Истина, СИстекшимСрокомПолезногоИспользования = Ложь) Экспорт

	Запрос = Новый Запрос();
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;

	Запрос.УстановитьПараметр("Дата",          ДокОбъект.Дата);
	Запрос.УстановитьПараметр("Организация",   ДокОбъект.Организация);
	Запрос.УстановитьПараметр("Подразделение", ДокОбъект.ПодразделениеОрганизации);
	Запрос.УстановитьПараметр("ВключатьЗабалансовые",                  ВключатьЗабалансовые);
	Запрос.УстановитьПараметр("СИстекшимСрокомПолезногоИспользования", СИстекшимСрокомПолезногоИспользования);
	// Если передается ДанныеФормыСтруктура
	Если ДокОбъект.Ссылка.Пустая() Тогда
		Запрос.УстановитьПараметр("Период", Новый Граница(ДокОбъект.Дата, ВидГраницы.Исключая));
	Иначе
		Запрос.УстановитьПараметр("Период",
			Новый Граница(Новый МоментВремени(ДокОбъект.Дата, ДокОбъект.Ссылка), ВидГраницы.Исключая));
	КонецЕсли;
	Запрос.УстановитьПараметр("СчетаУчетаСпецодежды",   
		БухгалтерскийУчетПовтИсп.СчетаВИерархии(ПланыСчетов.Хозрасчетный.СпецодеждаВЭксплуатации));
	
	Запрос.Текст = "
		|/////////////////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ХозрасчетныйОстаткиМЦ.Субконто1           КАК Субконто1,
		|	ВЫРАЗИТЬ(ХозрасчетныйОстаткиМЦ.Субконто2 КАК Документ.ПередачаМатериаловВЭксплуатацию) КАК Субконто2,
		|	ХозрасчетныйОстаткиМЦ.Субконто3           КАК Субконто3,
		|	ХозрасчетныйОстаткиМЦ.КоличествоОстатокДт КАК КоличествоОстатокДт
		|ПОМЕСТИТЬ
		|	ВТ_ОстаткиМЦ_Передача
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(
		|		&Период,
		|		Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.СпецодеждаВЭксплуатацииВспомогательный), // МЦ.02
		|		,
		|		Организация = &Организация
		|			И (Подразделение = &Подразделение ИЛИ Подразделение ЕСТЬ NULL)
		|			И Субконто2 ССЫЛКА Документ.ПередачаМатериаловВЭксплуатацию
		|	) КАК ХозрасчетныйОстаткиМЦ
		|ИНДЕКСИРОВАТЬ ПО
		|	Субконто1,
		|	Субконто2,
		|	Субконто3
		|;
		|
		|/////////////////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ХозрасчетныйОстатки.Счет                КАК Счет,
		|	ХозрасчетныйОстатки.Субконто1           КАК Субконто1,
		|	ХозрасчетныйОстатки.Субконто2           КАК Субконто2,
		|	ХозрасчетныйОстатки.Субконто3           КАК Субконто3,
		|	ХозрасчетныйОстатки.СуммаОстатокДт      КАК СуммаОстатокДт,
		|	ХозрасчетныйОстатки.КоличествоОстатокДт КАК КоличествоОстатокДт
		|ПОМЕСТИТЬ
		|	ВТ_Остатки_Передача
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(
		|		&Период,
		|		Счет В (&СчетаУчетаСпецодежды), // 10.11.1
		|		,
		|		Организация = &Организация
		|			И (Подразделение = &Подразделение ИЛИ Подразделение ЕСТЬ NULL)
		|			И Субконто2 ССЫЛКА Документ.ПередачаМатериаловВЭксплуатацию
		|	) КАК ХозрасчетныйОстатки
		|ИНДЕКСИРОВАТЬ ПО
		|	Субконто1,
		|	Субконто2,
		|	Субконто3
		|;
		|
		|/////////////////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ХозрасчетныйОстаткиМЦ.Субконто1           КАК Субконто1,
		|	ВЫРАЗИТЬ(ХозрасчетныйОстаткиМЦ.Субконто2 КАК Документ.ПартияМатериаловВЭксплуатации) КАК Субконто2,
		|	ХозрасчетныйОстаткиМЦ.Субконто3           КАК Субконто3,
		|	ХозрасчетныйОстаткиМЦ.КоличествоОстатокДт КАК КоличествоОстатокДт
		|ПОМЕСТИТЬ
		|	ВТ_ОстаткиМЦ_Партия
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(
		|		&Период,
		|		Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.СпецодеждаВЭксплуатацииВспомогательный), // МЦ.02
		|		,
		|		Организация = &Организация
		|			И (Подразделение = &Подразделение ИЛИ Подразделение ЕСТЬ NULL)
		|			И Субконто2 ССЫЛКА Документ.ПартияМатериаловВЭксплуатации
		|	) КАК ХозрасчетныйОстаткиМЦ
		|ИНДЕКСИРОВАТЬ ПО
		|	Субконто1,
		|	Субконто2,
		|	Субконто3
		|;
		|
		|/////////////////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ХозрасчетныйОстатки.Счет                КАК Счет,
		|	ХозрасчетныйОстатки.Субконто1           КАК Субконто1,
		|	ХозрасчетныйОстатки.Субконто2           КАК Субконто2,
		|	ХозрасчетныйОстатки.Субконто3           КАК Субконто3,
		|	ХозрасчетныйОстатки.СуммаОстатокДт      КАК СуммаОстатокДт,
		|	ХозрасчетныйОстатки.КоличествоОстатокДт КАК КоличествоОстатокДт
		|ПОМЕСТИТЬ
		|	ВТ_Остатки_Партия
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(
		|		&Период,
		|		Счет В (&СчетаУчетаСпецодежды), // 10.11.1
		|		,
		|		Организация = &Организация
		|			И (Подразделение = &Подразделение ИЛИ Подразделение ЕСТЬ NULL)
		|			И Субконто2 ССЫЛКА Документ.ПартияМатериаловВЭксплуатации
		|	) КАК ХозрасчетныйОстатки
		|ИНДЕКСИРОВАТЬ ПО
		|	Субконто1,
		|	Субконто2,
		|	Субконто3
		|;
		|
		|/////////////////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_ОстаткиМЦ_Передача.Субконто1                                                              КАК Номенклатура,
		|	ВТ_ОстаткиМЦ_Передача.Субконто2                                                              КАК ПартияМатериаловВЭксплуатации,
		|	ВТ_ОстаткиМЦ_Передача.Субконто3                                                              КАК Физлицо,
		|	ЕСТЬNULL(ВТ_ОстаткиМЦ_Передача.КоличествоОстатокДт, ВТ_Остатки_Передача.КоличествоОстатокДт) КАК Количество,
		|	ВЫБОР КОГДА ЕСТЬNULL(ВТ_Остатки_Передача.КоличествоОстатокДт, 0) = 0 ТОГДА
		|		ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.СпецодеждаВЭксплуатацииВспомогательный)
		|	ИНАЧЕ
		|		ВТ_Остатки_Передача.Счет
		|	КОНЕЦ                                                                                        КАК СчетПередачи
		|ИЗ
		|	ВТ_ОстаткиМЦ_Передача
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|	ВТ_Остатки_Передача
		|	ПО
		|		ВТ_ОстаткиМЦ_Передача.Субконто1 = ВТ_Остатки_Передача.Субконто1
		|		И ВТ_ОстаткиМЦ_Передача.Субконто2 = ВТ_Остатки_Передача.Субконто2
		|		И ВТ_ОстаткиМЦ_Передача.Субконто3 = ВТ_Остатки_Передача.Субконто3
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|	Документ.ПередачаМатериаловВЭксплуатацию.Спецодежда КАК ПередачаМатериаловВЭксплуатациюСпецодежда
		|	ПО
		|		ВТ_ОстаткиМЦ_Передача.Субконто1 = ПередачаМатериаловВЭксплуатациюСпецодежда.Номенклатура
		|		И ВТ_ОстаткиМЦ_Передача.Субконто2 = ПередачаМатериаловВЭксплуатациюСпецодежда.Ссылка
		|		И ВТ_ОстаткиМЦ_Передача.Субконто3 = ПередачаМатериаловВЭксплуатациюСпецодежда.ФизЛицо
		|ГДЕ
		|	// Включать забалансовые
		|	((&ВключатьЗабалансовые = ЛОЖЬ
		|		И (ЕСТЬNULL(ВТ_Остатки_Передача.КоличествоОстатокДт, 0) > 0) И (ЕСТЬNULL(ВТ_Остатки_Передача.СуммаОстатокДт, 0) > 0))
		|	ИЛИ (&ВключатьЗабалансовые))
		|
		|	И
		|	// С истекшим сроком хранения
		|	((&СИстекшимСрокомПолезногоИспользования
		|		И ДОБАВИТЬКДАТЕ(ВТ_ОстаткиМЦ_Передача.Субконто2.Дата, МЕСЯЦ, ПередачаМатериаловВЭксплуатациюСпецодежда.НазначениеИспользования.СрокПолезногоИспользования) < &Дата)
		|	ИЛИ (&СИстекшимСрокомПолезногоИспользования = ЛОЖЬ))
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТ_ОстаткиМЦ_Партия.Субконто1,
		|	ВТ_ОстаткиМЦ_Партия.Субконто2,
		|	ВТ_ОстаткиМЦ_Партия.Субконто3,
		|	ЕСТЬNULL(ВТ_ОстаткиМЦ_Партия.КоличествоОстатокДт, ВТ_Остатки_Партия.КоличествоОстатокДт),
		|	ВЫБОР КОГДА ЕСТЬNULL(ВТ_Остатки_Партия.КоличествоОстатокДт, 0) = 0 ТОГДА
		|		ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.СпецодеждаВЭксплуатацииВспомогательный)
		|	ИНАЧЕ
		|		ВТ_Остатки_Партия.Счет
		|	КОНЕЦ
		|ИЗ
		|	ВТ_ОстаткиМЦ_Партия
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|	ВТ_Остатки_Партия
		|	ПО
		|		ВТ_ОстаткиМЦ_Партия.Субконто1 = ВТ_Остатки_Партия.Субконто1
		|		И ВТ_ОстаткиМЦ_Партия.Субконто2 = ВТ_Остатки_Партия.Субконто2
		|		И ВТ_ОстаткиМЦ_Партия.Субконто3 = ВТ_Остатки_Партия.Субконто3
		|ГДЕ
		|	// Включать забалансовые
		|	((&ВключатьЗабалансовые = ЛОЖЬ
		|		И (ЕСТЬNULL(ВТ_Остатки_Партия.КоличествоОстатокДт, 0) > 0) И (ЕСТЬNULL(ВТ_Остатки_Партия.СуммаОстатокДт, 0) > 0))
		|	ИЛИ (&ВключатьЗабалансовые))
		|
		|	И
		|	// С истекшим сроком хранения
		|	((&СИстекшимСрокомПолезногоИспользования
		|		И ДОБАВИТЬКДАТЕ(ВТ_ОстаткиМЦ_Партия.Субконто2.Дата, МЕСЯЦ, ВТ_ОстаткиМЦ_Партия.Субконто2.НазначениеИспользования.СрокПолезногоИспользования) < &Дата)
		|	ИЛИ (&СИстекшимСрокомПолезногоИспользования = ЛОЖЬ))
		|";

	ОстаткиМатериалов = Запрос.Выполнить().Выгрузить();

	ТаблицаМатериалы.Загрузить(ОстаткиМатериалов);

КонецПроцедуры

// Процедура формирует таблицу остатков спецоснастки в незавершенном производстве.
//
Процедура ЗаполнитьСпецоснасткуПоОстаткамВЭксплуатации(ДокОбъект, ТаблицаМатериалы, ВключатьЗабалансовые = Истина, СИстекшимСрокомПолезногоИспользования = Ложь) Экспорт

	Запрос = Новый Запрос();
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;

	Запрос.УстановитьПараметр("Дата",          ДокОбъект.Дата);
	Запрос.УстановитьПараметр("Организация",   ДокОбъект.Организация);
	Запрос.УстановитьПараметр("Подразделение", ДокОбъект.ПодразделениеОрганизации);
	Запрос.УстановитьПараметр("ВключатьЗабалансовые",                  ВключатьЗабалансовые);
	Запрос.УстановитьПараметр("СИстекшимСрокомПолезногоИспользования", СИстекшимСрокомПолезногоИспользования);
	// Если передается ДанныеФормыСтруктура
	Если ДокОбъект.Ссылка.Пустая() Тогда
		Запрос.УстановитьПараметр("Период", Новый Граница(ДокОбъект.Дата, ВидГраницы.Исключая));
	Иначе
		Запрос.УстановитьПараметр("Период",
			Новый Граница(Новый МоментВремени(ДокОбъект.Дата, ДокОбъект.Ссылка), ВидГраницы.Исключая));
	КонецЕсли;
	Запрос.УстановитьПараметр("СчетаУчетаСпецоснастки",            
		БухгалтерскийУчетПовтИсп.СчетаВИерархии(ПланыСчетов.Хозрасчетный.СпецоснасткаВЭксплуатации));

	Запрос.Текст = "
		|/////////////////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ХозрасчетныйОстаткиМЦ.Субконто1           КАК Субконто1,
		|	ХозрасчетныйОстаткиМЦ.Субконто2           КАК Субконто2,
		|	ХозрасчетныйОстаткиМЦ.КоличествоОстатокДт КАК КоличествоОстатокДт
		|ПОМЕСТИТЬ
		|	ВТ_ОстаткиМЦ_Передача
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(
		|		&Период,
		|		Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.СпецоснасткаВЭксплуатацииВспомогательный), // МЦ.03
		|		,
		|		Организация = &Организация
		|			И (Подразделение = &Подразделение ИЛИ Подразделение ЕСТЬ NULL)
		|			И Субконто2 ССЫЛКА Документ.ПередачаМатериаловВЭксплуатацию
		|	) КАК ХозрасчетныйОстаткиМЦ
		|ИНДЕКСИРОВАТЬ ПО
		|	Субконто1,
		|	Субконто2
		|;
		|
		|/////////////////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ХозрасчетныйОстатки.Счет                КАК Счет,
		|	ХозрасчетныйОстатки.Субконто1           КАК Субконто1,
		|	ХозрасчетныйОстатки.Субконто2           КАК Субконто2,
		|	ХозрасчетныйОстатки.СуммаОстатокДт      КАК СуммаОстатокДт,
		|	ХозрасчетныйОстатки.КоличествоОстатокДт КАК КоличествоОстатокДт
		|ПОМЕСТИТЬ
		|	ВТ_Остатки_Передача
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(
		|		&Период,
		|		Счет В (&СчетаУчетаСпецоснастки), // 10.11.2
		|		,
		|		Организация = &Организация
		|			И (Подразделение = &Подразделение ИЛИ Подразделение ЕСТЬ NULL)
		|			И Субконто2 ССЫЛКА Документ.ПередачаМатериаловВЭксплуатацию
		|	) КАК ХозрасчетныйОстатки
		|ИНДЕКСИРОВАТЬ ПО
		|	Субконто1,
		|	Субконто2
		|;
		|
		|/////////////////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ХозрасчетныйОстаткиМЦ.Субконто1           КАК Субконто1,
		|	ХозрасчетныйОстаткиМЦ.Субконто2           КАК Субконто2,
		|	ХозрасчетныйОстаткиМЦ.КоличествоОстатокДт КАК КоличествоОстатокДт
		|ПОМЕСТИТЬ
		|	ВТ_ОстаткиМЦ_Партия
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(
		|		&Период,
		|		Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.СпецоснасткаВЭксплуатацииВспомогательный), // МЦ.03
		|		,
		|		Организация = &Организация
		|			И (Подразделение = &Подразделение ИЛИ Подразделение ЕСТЬ NULL)
		|			И Субконто2 ССЫЛКА Документ.ПартияМатериаловВЭксплуатации
		|	) КАК ХозрасчетныйОстаткиМЦ
		|ИНДЕКСИРОВАТЬ ПО
		|	Субконто1,
		|	Субконто2
		|;
		|
		|/////////////////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ХозрасчетныйОстатки.Счет                КАК Счет,
		|	ХозрасчетныйОстатки.Субконто1           КАК Субконто1,
		|	ХозрасчетныйОстатки.Субконто2           КАК Субконто2,
		|	ХозрасчетныйОстатки.СуммаОстатокДт      КАК СуммаОстатокДт,
		|	ХозрасчетныйОстатки.КоличествоОстатокДт КАК КоличествоОстатокДт
		|ПОМЕСТИТЬ
		|	ВТ_Остатки_Партия
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(
		|		&Период,
		|		Счет В (&СчетаУчетаСпецоснастки), // 10.11.2
		|		,
		|		Организация = &Организация
		|			И (Подразделение = &Подразделение ИЛИ Подразделение ЕСТЬ NULL)
		|			И Субконто2 ССЫЛКА Документ.ПартияМатериаловВЭксплуатации
		|	) КАК ХозрасчетныйОстатки
		|ИНДЕКСИРОВАТЬ ПО
		|	Субконто1,
		|	Субконто2
		|;
		|
		|/////////////////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_ОстаткиМЦ_Передача.Субконто1                                                              КАК Номенклатура,
		|	ВТ_ОстаткиМЦ_Передача.Субконто2                                                              КАК ПартияМатериаловВЭксплуатации,
		|	ЕСТЬNULL(ВТ_ОстаткиМЦ_Передача.КоличествоОстатокДт, ВТ_Остатки_Передача.КоличествоОстатокДт) КАК Количество,
		|	ВЫБОР КОГДА ЕСТЬNULL(ВТ_Остатки_Передача.КоличествоОстатокДт, 0) = 0 ТОГДА
		|		ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.СпецоснасткаВЭксплуатацииВспомогательный)
		|	ИНАЧЕ
		|		ВТ_Остатки_Передача.Счет
		|	КОНЕЦ                                                                                        КАК СчетПередачи
		|ИЗ
		|	ВТ_ОстаткиМЦ_Передача
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|	ВТ_Остатки_Передача
		|	ПО
		|		ВТ_ОстаткиМЦ_Передача.Субконто1 = ВТ_Остатки_Передача.Субконто1
		|		И ВТ_ОстаткиМЦ_Передача.Субконто2 = ВТ_Остатки_Передача.Субконто2
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|	Документ.ПередачаМатериаловВЭксплуатацию.Спецоснастка КАК ПередачаМатериаловВЭксплуатациюСпецоснастка
		|	ПО
		|		ВТ_ОстаткиМЦ_Передача.Субконто1 = ПередачаМатериаловВЭксплуатациюСпецоснастка.Номенклатура
		|		И ВТ_ОстаткиМЦ_Передача.Субконто2 = ПередачаМатериаловВЭксплуатациюСпецоснастка.Ссылка
		|ГДЕ
		|	// Включать забалансовые
		|	((&ВключатьЗабалансовые = ЛОЖЬ
		|		И (ЕСТЬNULL(ВТ_Остатки_Передача.КоличествоОстатокДт, 0) > 0))
		|	ИЛИ (&ВключатьЗабалансовые))
		|
		|	И
		|	// С истекшим сроком хранения
		|	((&СИстекшимСрокомПолезногоИспользования
		|		И ДОБАВИТЬКДАТЕ(ВТ_ОстаткиМЦ_Передача.Субконто2.Дата, МЕСЯЦ, ПередачаМатериаловВЭксплуатациюСпецоснастка.НазначениеИспользования.СрокПолезногоИспользования) < &Дата)
		|	ИЛИ (&СИстекшимСрокомПолезногоИспользования = ЛОЖЬ))
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТ_ОстаткиМЦ_Партия.Субконто1,
		|	ВТ_ОстаткиМЦ_Партия.Субконто2,
		|	ЕСТЬNULL(ВТ_ОстаткиМЦ_Партия.КоличествоОстатокДт, ВТ_Остатки_Партия.КоличествоОстатокДт),
		|	ВЫБОР КОГДА ЕСТЬNULL(ВТ_Остатки_Партия.КоличествоОстатокДт, 0) = 0 ТОГДА
		|		ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.СпецоснасткаВЭксплуатацииВспомогательный)
		|	ИНАЧЕ
		|		ВТ_Остатки_Партия.Счет
		|	КОНЕЦ
		|ИЗ
		|	ВТ_ОстаткиМЦ_Партия
		|	
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|	ВТ_Остатки_Партия
		|	ПО
		|		ВТ_ОстаткиМЦ_Партия.Субконто1 = ВТ_Остатки_Партия.Субконто1
		|		И ВТ_ОстаткиМЦ_Партия.Субконто2 = ВТ_Остатки_Партия.Субконто2
		|ГДЕ
		|	// Включать забалансовые
		|	((&ВключатьЗабалансовые = ЛОЖЬ
		|		И (ЕСТЬNULL(ВТ_Остатки_Партия.КоличествоОстатокДт, 0) > 0))
		|	ИЛИ (&ВключатьЗабалансовые))
		|
		|	И
		|	// С истекшим сроком хранения
		|	((&СИстекшимСрокомПолезногоИспользования
		|		И ДОБАВИТЬКДАТЕ(ВТ_ОстаткиМЦ_Партия.Субконто2.Дата, МЕСЯЦ, ВТ_ОстаткиМЦ_Партия.Субконто2.НазначениеИспользования.СрокПолезногоИспользования) < &Дата)
		|	ИЛИ (&СИстекшимСрокомПолезногоИспользования = ЛОЖЬ))
		|";

	ОстаткиМатериалов = Запрос.Выполнить().Выгрузить();

	ТаблицаМатериалы.Загрузить(ОстаткиМатериалов);

КонецПроцедуры

// Процедура формирует таблицу остатков инвентаря и хозяйственных
// принадлежностей на забалансовом счете.
//
Процедура ЗаполнитьИнвентарьИХозяйственныеПринадлежностиПоОстаткамВЭксплуатации(ДокОбъект, ТаблицаМатериалы) Экспорт

	Запрос = Новый Запрос();

	// Если передается ДанныеФормыСтруктура
	Если ДокОбъект.Ссылка.Пустая() Тогда
		Запрос.УстановитьПараметр("Период", Новый Граница(ДокОбъект.Дата, ВидГраницы.Исключая));
	Иначе
		Запрос.УстановитьПараметр("Период",
			Новый Граница(Новый МоментВремени(ДокОбъект.Дата, ДокОбъект.Ссылка), ВидГраницы.Исключая));
	КонецЕсли;
	Запрос.УстановитьПараметр("Организация",   ДокОбъект.Организация);
	Запрос.УстановитьПараметр("Подразделение", ДокОбъект.ПодразделениеОрганизации);

	Запрос.Текст =
	"ВЫБРАТЬ
	|	ХозрасчетныйОстаткиМЦ.Субконто1 КАК Номенклатура,
	|	ХозрасчетныйОстаткиМЦ.Субконто2 КАК ПартияМатериаловВЭксплуатации,
	|	ХозрасчетныйОстаткиМЦ.Субконто3 КАК Физлицо,
	|	ХозрасчетныйОстаткиМЦ.КоличествоОстатокДт КАК Количество
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(
	|			&Период,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ИнвентарьИХозяйственныеПринадлежностиВЭксплуатации),
	|			,
	|			Организация = &Организация
	|				И (Подразделение = &Подразделение
	|					ИЛИ Подразделение ЕСТЬ NULL )
	|				И Субконто2 ССЫЛКА Документ.ПередачаМатериаловВЭксплуатацию) КАК ХозрасчетныйОстаткиМЦ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ХозрасчетныйОстаткиМЦ.Субконто1,
	|	ХозрасчетныйОстаткиМЦ.Субконто2,
	|	ХозрасчетныйОстаткиМЦ.Субконто3,
	|	ХозрасчетныйОстаткиМЦ.КоличествоОстатокДт
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(
	|			&Период,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ИнвентарьИХозяйственныеПринадлежностиВЭксплуатации),
	|			,
	|			Организация = &Организация
	|				И (Подразделение = &Подразделение
	|					ИЛИ Подразделение ЕСТЬ NULL )
	|				И Субконто2 ССЫЛКА Документ.ПартияМатериаловВЭксплуатации) КАК ХозрасчетныйОстаткиМЦ
	|
	|УПОРЯДОЧИТЬ ПО
	|	Номенклатура";

	ОстаткиМатериалов = Запрос.Выполнить().Выгрузить();

	ТаблицаМатериалы.Загрузить(ОстаткиМатериалов);

КонецПроцедуры
